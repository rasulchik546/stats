<!doctype html>
<html lang="ru">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>–°—Ç–∞—Ç–∏—Å—Ç–∏—á–µ—Å–∫–∏–π —Ç—Ä–µ–∫–µ—Ä ‚Äî K/A/D/W/L/ROUNDS ‚Äî Enhanced + Ranks</title>
<style>
  :root{
    --bg:#0b0b0b; --panel:#0f1113; --text:#e9eef8; --muted:#9aa3b2; --accent:#6ee7b7; --glass: rgba(255,255,255,0.03);
    --card-shadow: 0 6px 18px rgba(0,0,0,0.45);
    --radius:12px;
  }
  [data-theme="light"]{ --bg:#f6f8fa; --panel:#ffffff; --text:#0b1220; --muted:#556270; --accent:#0f766e; --glass: rgba(10,10,10,0.03); }
  *{box-sizing:border-box;font-family:Inter,ui-sans-serif,system-ui,-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,"Helvetica Neue",Arial}
  html,body{height:100%;margin:0;background:linear-gradient(180deg,var(--bg),#07080a);color:var(--text);-webkit-font-smoothing:antialiased}
  .wrap{max-width:1200px;margin:18px auto;padding:16px;display:grid;grid-template-columns:320px 1fr 320px;gap:14px}
  header{grid-column:1/-1;display:flex;justify-content:space-between;align-items:center;margin-bottom:6px}
  h1{font-size:18px;margin:0;color:var(--accent)}
  .card{background:linear-gradient(180deg,var(--panel),rgba(255,255,255,0.01));padding:14px;border-radius:var(--radius);box-shadow:var(--card-shadow);border:1px solid rgba(255,255,255,0.03)}
  label{font-size:13px;color:var(--muted);display:block;margin-bottom:6px}
  input[type="text"],input[type="number"],select{width:100%;padding:10px;border-radius:10px;border:1px solid rgba(255,255,255,0.04);background:transparent;color:var(--text);font-size:14px}
  .players{display:flex;flex-direction:column;gap:8px;max-height:64vh;overflow:auto;margin-top:10px}
  .player-row{display:flex;justify-content:space-between;align-items:center;padding:10px;border-radius:10px}
  .player-row:hover{background:var(--glass)}
  .player-row.selected{outline:2px solid rgba(255,255,255,0.04);background:linear-gradient(90deg, rgba(255,255,255,0.02), transparent)}
  .stat-grid{display:grid;grid-template-columns:repeat(3,1fr);gap:10px;margin-top:10px}
  .stat{background:rgba(255,255,255,0.01);padding:12px;border-radius:10px;text-align:center}
  .ops{display:flex;gap:6px;justify-content:center;margin-top:8px}
  .hotbar{display:flex;justify-content:space-between;align-items:center;padding:10px;margin-top:10px;border-radius:8px;background:rgba(255,255,255,0.01)}
  button{padding:8px 10px;border-radius:8px;border:1px solid rgba(255,255,255,0.04);background:transparent;color:var(--text);cursor:pointer}
  .small{font-size:13px;color:var(--muted)}
  footer{grid-column:1/-1;text-align:center;color:var(--muted);margin-top:10px;font-size:13px}
  .controls{display:flex;gap:8px;align-items:center}
  .search{display:flex;gap:8px;margin-top:10px}
  .flex{display:flex;gap:8px}
  .leader{display:flex;flex-direction:column;gap:8px;margin-top:10px}
  canvas.spark{width:100%;height:40px;border-radius:6px;display:block}
  .muted-pill{padding:6px 8px;border-radius:999px;background:rgba(255,255,255,0.02);font-size:12px;color:var(--muted)}
  .badge{padding:4px 8px;border-radius:999px;background:rgba(255,255,255,0.03);font-size:12px}
  .rank-silver{background:linear-gradient(90deg,#c0c0c0,#b0b0b0);color:#111}
  .rank-gold{background:linear-gradient(90deg,#ffd27f,#f6c85f);color:#111}
  .rank-platinum{background:linear-gradient(90deg,#cfeaf5,#9ad3e8);color:#111}
  .rank-diamond{background:linear-gradient(90deg,#b7e0ff,#8fcfff);color:#011}
  .rank-emerald{background:linear-gradient(90deg,#7bf0b3,#4edc93);color:#012}
  .rank-global{background:linear-gradient(90deg,#ffd3ff,#ffb7f0);color:#111}
  @media (max-width:1100px){.wrap{grid-template-columns:1fr 360px;max-width:980px} aside:last-child{order:3} }
  @media (max-width:800px){.wrap{grid-template-columns:1fr;padding:12px} header{flex-direction:column;align-items:flex-start;gap:8px} .players{max-height:36vh} .stat-grid{grid-template-columns:repeat(2,1fr)} }
  /* –°—Ä–∞–≤–Ω–µ–Ω–∏–µ */
  .compare-metric { display: flex; justify-content: space-between; padding: 6px; border-radius: 6px; background: rgba(255,255,255,0.02); margin-bottom: 4px; }
  .better { color: var(--accent); font-weight: 700; }
</style>
</head>
<body data-theme="dark">
  <div class="wrap">
    <header>
      <div>
        <h1>–¢—Ä–µ–∫–µ—Ä –∏–≥—Ä–æ–∫–æ–≤ ‚Äî K/A/D / MATCH W/L / ROUNDS</h1>
        <div class="small">–õ–æ–∫–∞–ª—å–Ω–æ ‚Üí localStorage ‚Ä¢ –†–∞–Ω–≥–∏ –∏ –Ω–æ–º–∏–Ω–∞—Ü–∏–∏ –¥–æ–±–∞–≤–ª–µ–Ω—ã</div>
      </div>
      <div style="display:flex;gap:8px;align-items:center">
        <div class="controls">
          <button id="themeToggle">–¢–µ–º–∞</button>
          <button id="exportBtn">–≠–∫—Å–ø–æ—Ä—Ç</button>
          <button id="importBtn">–ò–º–ø–æ—Ä—Ç</button>
        </div>
      </div>
    </header>

    <!-- LEFT: —Ñ–æ—Ä–º–∞ + —Å–ø–∏—Å–æ–∫ -->
    <aside class="card">
      <div style="display:flex;justify-content:space-between;align-items:center">
        <strong>–°–æ–∑–¥–∞—Ç—å –∏–≥—Ä–æ–∫–∞</strong>
        <div class="small" id="count">0</div>
      </div>

      <div style="margin-top:8px">
        <label>–ò–º—è</label>
        <input id="name" type="text" placeholder="–ù–∏–∫–Ω–µ–π–º">
      </div>

      <div style="display:grid;grid-template-columns:1fr 1fr;gap:8px;margin-top:8px">
        <div>
          <label>KILLS</label>
          <input id="kills" type="number" min="0" value="0">
        </div>
        <div>
          <label>ASSISTS</label>
          <input id="assists" type="number" min="0" value="0">
        </div>
        <div>
          <label>DEATHS</label>
          <input id="deaths" type="number" min="0" value="0">
        </div>
        <div>
          <label>ROUNDS (–∫–æ–ª-–≤–æ —Ä–∞—É–Ω–¥–æ–≤)</label>
          <input id="rounds" type="number" min="0" value="0">
        </div>
        <div>
          <label>WINS (MATCH WINS ‚Äî –ø–æ–±–µ–¥—ã –≤ –º–∞—Ç—á–∞—Ö)</label>
          <input id="wins" type="number" min="0" value="0">
        </div>
        <div>
          <label>LOSES (MATCH LOSES ‚Äî –ø–æ—Ä–∞–∂–µ–Ω–∏—è –≤ –º–∞—Ç—á–∞—Ö)</label>
          <input id="loses" type="number" min="0" value="0">
        </div>
      </div>

      <div style="display:flex;gap:8px;margin-top:10px">
        <button id="addBtn">–î–æ–±–∞–≤–∏—Ç—å</button>
        <button id="addZeroBtn">–î–æ–±–∞–≤–∏—Ç—å (—Å 0)</button>
        <button id="clearForm">–°–±—Ä–æ—Å</button>
      </div>

      <hr style="margin:10px 0;border:none;height:8px">

      <div style="display:flex;justify-content:space-between;align-items:center">
        <strong>–ü–æ–∏—Å–∫ / –°–æ—Ä—Ç</strong>
        <div class="small">–∫–ª–∏–∫–∏: –æ—Ç–∫—Ä—ã—Ç—å / –¥—É–±–ª–∏—Ä–æ–≤–∞—Ç—å</div>
      </div>

      <div class="search">
        <input id="searchInput" type="text" placeholder="–ü–æ–∏—Å–∫ –ø–æ –∏–º–µ–Ω–∏...">
        <select id="sortSelect" title="–°–æ—Ä—Ç–∏—Ä–æ–≤–∞—Ç—å">
          <option value="created">–°–Ω–∞—á–∞–ª–∞ –Ω–æ–≤—ã–µ</option>
          <option value="rating">–ü–æ —Ä–µ–π—Ç–∏–Ω–≥—É</option>
          <option value="kills">–ü–æ –∫–∏–ª–ª–∞–º</option>
          <option value="wins">–ü–æ –ø–æ–±–µ–¥–∞–º</option>
        </select>
      </div>

      <div class="players" id="playersList"></div>

      <div class="leader card" style="margin-top:10px">
        <div class="small">–¢–æ–ø 3 (–ø–æ —Ä–µ–π—Ç–∏–Ω–≥—É)</div>
        <div id="topList" style="display:flex;gap:8px"></div>
      </div>

      <div class="card" style="margin-top:10px">
        <div class="small"><strong>–ù–æ–º–∏–Ω–∞—Ü–∏–∏ (–∫—Ç–æ —á—Ç–æ —É–Ω–∏—á—Ç–∂–∞–ª)</strong></div>
        <div id="nominationsList" style="margin-top:8px;display:flex;flex-direction:column;gap:6px"></div>
      </div>
    </aside>

    <!-- CENTER: –¥–µ—Ç–∞–ª–∏ –≤—ã–±—Ä–∞–Ω–Ω–æ–≥–æ + —Å—Ä–∞–≤–Ω–µ–Ω–∏–µ -->
    <main class="card">
      <div style="display:flex;justify-content:space-between;align-items:center;gap:12px;flex-wrap:wrap">
        <div style="display:flex;align-items:center;gap:8px">
          <div id="selName" style="font-weight:700">–ù–µ—Ç –≤—ã–±—Ä–∞–Ω–Ω–æ–≥–æ –∏–≥—Ä–æ–∫–∞</div>
          <button id="renamePlayer" title="–ü–µ—Ä–µ–∏–º–µ–Ω–æ–≤–∞—Ç—å" style="padding:4px 8px;">‚úèÔ∏è</button>
        </div>
        <div style="display:flex;gap:8px;align-items:center">
          <div id="selRank" class="badge" style="display:none"></div>
          <button id="resetPlayer">–°–±—Ä–æ—Å–∏—Ç—å —Å—á—ë—Ç—á–∏–∫–∏</button>
          <button id="deletePlayer" style="color:#ff7b7b">–£–¥–∞–ª–∏—Ç—å</button>
        </div>
      </div>
      <div id="selInfo" class="small" style="margin-bottom:10px;">–í—ã–±–µ—Ä–∏—Ç–µ –∏–≥—Ä–æ–∫–∞ —Å–ª–µ–≤–∞</div>

      <div class="stat-grid" id="statGrid">
        <div class="stat">
          <div class="small">KILLS</div><div id="vKills" style="font-weight:700">‚Äî</div>
          <div class="ops">
            <button data-op="k+">+1</button><button data-op="k-">-1</button><button id="editKills">–ò–∑–º.</button>
          </div>
        </div>
        <div class="stat">
          <div class="small">ASSISTS</div><div id="vAssists" style="font-weight:700">‚Äî</div>
          <div class="ops">
            <button data-op="a+">+1</button><button data-op="a-">-1</button><button id="editAssists">–ò–∑–º.</button>
          </div>
        </div>
        <div class="stat">
          <div class="small">DEATHS</div><div id="vDeaths" style="font-weight:700">‚Äî</div>
          <div class="ops">
            <button data-op="d+">+1</button><button data-op="d-">-1</button><button id="editDeaths">–ò–∑–º.</button>
          </div>
        </div>
        <div class="stat">
          <div class="small">ROUNDS</div><div id="vRounds" style="font-weight:700">‚Äî</div>
          <div class="ops">
            <button data-op="r+">+1</button><button data-op="r-">-1</button><button id="editRounds">–ò–∑–º.</button>
          </div>
        </div>
        <div class="stat">
          <div class="small">WINS (MATCH)</div><div id="vWins" style="font-weight:700">‚Äî</div>
          <div class="ops">
            <button data-op="w+">+1</button><button data-op="w-">-1</button><button id="editWins">–ò–∑–º.</button>
          </div>
        </div>
        <div class="stat">
          <div class="small">LOSES (MATCH)</div><div id="vLoses" style="font-weight:700">‚Äî</div>
          <div class="ops">
            <button data-op="l+">+1</button><button data-op="l-">-1</button><button id="editLoses">–ò–∑–º.</button>
          </div>
        </div>
      </div>

      <div style="display:flex;gap:10px;margin-top:12px;flex-wrap:wrap">
        <div class="card" style="flex:1;min-width:220px">
          <div class="small">KD = KILLS / DEATHS</div>
          <div id="vKD" style="font-weight:700;margin-top:6px">‚Äî</div>
          <div class="small" style="margin-top:6px">–ï—Å–ª–∏ DEATHS = 0 ‚Üí –æ—Ç–æ–±—Ä–∞–∂–∞–µ–º "Perfect" –∏ –≤ —Ä–∞—Å—á—ë—Ç–µ –∏—Å–ø–æ–ª—å–∑—É–µ–º DEATHS_FOR_CALC = 1.</div>
        </div>
        <div class="card" style="flex:1;min-width:220px">
          <div class="small">KAD = (KILLS + ASSISTS) / DEATHS</div>
          <div id="vKAD" style="font-weight:700;margin-top:6px">‚Äî</div>
        </div>
        <div class="card" style="flex:1;min-width:220px">
          <div class="small">AVG = KILLS / ROUNDS (—É–±–∏–π—Å—Ç–≤–∞ –∑–∞ —Ä–∞—É–Ω–¥)</div>
          <div id="vAVG" style="font-weight:700;margin-top:6px">‚Äî</div>
        </div>
        <div class="card" style="flex:1;min-width:220px">
          <div class="small">SVR = (ROUNDS ‚àí DEATHS) / ROUNDS √ó 100% (–≤—ã–∂–∏–≤–∞–µ–º–æ—Å—Ç—å)</div>
          <div id="vSVR" style="font-weight:700;margin-top:6px">‚Äî</div>
        </div>
        <div class="card" style="flex:1;min-width:220px">
          <div class="small">WINRATE = WINS / (WINS + LOSES) √ó 100% (–º–∞—Ç—á-–≤–¥–æ—Ö)</div>
          <div id="vWINRATE" style="font-weight:700;margin-top:6px">‚Äî</div>
        </div>
        <div class="card" style="flex:1 1 100%;min-width:220px">
          <div class="small">RATING ‚Äî –∫–æ–º–±–∏–Ω–∏—Ä–æ–≤–∞–Ω–Ω—ã–π –∏–Ω–¥–µ–∫—Å (0‚Äì100)</div>
          <div id="vRATING" style="font-weight:700;margin-top:6px">‚Äî</div>
          <div class="small" style="margin-top:6px">–ù–æ—Ä–º–∞–ª–∏–∑–∞—Ü–∏—è: KD cap 5, KAD cap 7, AVG cap 2, SVR 0‚Äì100, WINRATE 0‚Äì100.</div>
        </div>
      </div>

      <div class="hotbar" style="margin-top:12px">
        <div class="small">Hotbar: +1/‚àí1 ‚Äî –±—ã—Å—Ç—Ä—ã–µ –∏–∑–º–µ–Ω–µ–Ω–∏—è; "–ò–∑–º." ‚Äî –ø—Ä—è–º–æ–µ –∑–Ω–∞—á–µ–Ω–∏–µ; –≤—Å—ë —Å–æ—Ö—Ä–∞–Ω—è–µ—Ç—Å—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏.</div>
        <div style="display:flex;gap:8px;align-items:center">
          <button id="addMatchBtn">–î–æ–±–∞–≤–∏—Ç—å –º–∞—Ç—á</button>
          <div class="muted-pill" id="matchCount">–ú–∞—Ç—á–µ–π: 0</div>
        </div>
      </div>

      <div id="historyCard" class="card" style="margin-top:12px;display:none">
        <div style="display:flex;justify-content:space-between;align-items:center">
          <div class="small">–ò—Å—Ç–æ—Ä–∏—è –º–∞—Ç—á–µ–π (–ø–æ—Å–ª–µ–¥–Ω–∏–µ 12)</div>
          <div class="small"><button id="clearHistory">–û—á–∏—Å—Ç–∏—Ç—å –∏—Å—Ç–æ—Ä–∏—é</button></div>
        </div>
        <canvas id="spark" class="spark"></canvas>
        <div id="historyList" style="margin-top:8px;display:flex;flex-direction:column;gap:6px;max-height:160px;overflow:auto"></div>
      </div>

      <!-- –ù–û–í–´–ô –ë–õ–û–ö: –°—Ä–∞–≤–Ω–µ–Ω–∏–µ –∏–≥—Ä–æ–∫–æ–≤ -->
      <div class="card" id="compareCard" style="margin-top:12px;">
        <div style="display:flex;justify-content:space-between;align-items:center">
          <div class="small"><strong>‚öîÔ∏è –°—Ä–∞–≤–Ω–µ–Ω–∏–µ –∏–≥—Ä–æ–∫–æ–≤</strong></div>
          <button id="compareBtn">–°—Ä–∞–≤–Ω–∏—Ç—å</button>
        </div>
        <div style="display:flex;gap:12px;margin-top:8px;flex-wrap:wrap">
          <select id="comparePlayer1" style="flex:1;"></select>
          <select id="comparePlayer2" style="flex:1;"></select>
        </div>
        <div id="compareResult" style="margin-top:12px;"></div>
      </div>
    </main>

    <!-- RIGHT: –≤–µ—Å–∞ –∏ –ø–æ—è—Å–Ω–µ–Ω–∏—è + –ù–û–í–´–ô –ë–õ–û–ö: –ó–≤–∞–Ω–∏—è -->
    <aside class="card">
      <div style="display:flex;justify-content:space-between;align-items:center">
        <strong>–ü–∞—Ä–∞–º–µ—Ç—Ä—ã —Ä–µ–π—Ç–∏–Ω–≥–∞</strong>
        <button id="resetWeights">–°–±—Ä–æ—Å</button>
      </div>

      <div style="margin-top:10px">
        <label>–í–µ—Å KD</label>
        <input id="wKD" type="range" min="0" max="100" value="30">
      </div>
      <div style="margin-top:10px">
        <label>–í–µ—Å KAD</label>
        <input id="wKAD" type="range" min="0" max="100" value="25">
      </div>
      <div style="margin-top:10px">
        <label>–í–µ—Å AVG</label>
        <input id="wAVG" type="range" min="0" max="100" value="20">
      </div>
      <div style="margin-top:10px">
        <label>–í–µ—Å SVR</label>
        <input id="wSVR" type="range" min="0" max="100" value="10">
      </div>
      <div style="margin-top:10px">
        <label>–í–µ—Å WINRATE</label>
        <input id="wWIN" type="range" min="0" max="100" value="15">
      </div>

      <hr style="margin:10px 0;border:none;height:8px">

      <!-- –ù–û–í–´–ô –ë–õ–û–ö: –ó–≤–∞–Ω–∏—è (–æ–ø–∏—Å–∞–Ω–∏–µ) -->
      <div class="card" style="margin-top:0;padding:10px;">
        <div class="small"><strong>üèÜ –ó–≤–∞–Ω–∏—è (—Ä–∞–Ω–≥–∏)</strong></div>
        <div style="margin-top:8px; font-size:13px; display:flex; flex-direction:column; gap:6px;">
          <div><span class="badge rank-silver">ü•à Silver</span> 0‚Äì19%</div>
          <div><span class="badge rank-gold">ü•á Gold</span> 20‚Äì34%</div>
          <div><span class="badge rank-platinum">‚ö™ Platinum</span> 35‚Äì54%</div>
          <div><span class="badge rank-diamond">üíé Diamond</span> 55‚Äì74%</div>
          <div><span class="badge rank-emerald">üü¢ Emerald</span> 75‚Äì89%</div>
          <div><span class="badge rank-global">üåç Global</span> 90‚Äì100%</div>
        </div>
        <div class="small" style="margin-top:8px;">* —Ä–∞–Ω–≥ —Å—á–∏—Ç–∞–µ—Ç—Å—è –Ω–∞ –æ—Å–Ω–æ–≤–µ KD, KAD, AVG, SVR (–±–µ–∑ —É—á—ë—Ç–∞ –≤–∏–Ω—Ä–µ–π—Ç–∞)</div>
      </div>

      <hr style="margin:8px 0;border:none;height:8px">

      <div class="small">
        <strong>–§–æ—Ä–º—É–ª—ã (—Ç–æ—á–Ω–æ —Ä–µ–∞–ª–∏–∑–æ–≤–∞–Ω–æ –≤ –∫–æ–¥–µ):</strong>
        <ol>
          <li><b>K D</b> = KILLS / DEATHS. –ï—Å–ª–∏ DEATHS = 0 ‚Üí –æ—Ç–æ–±—Ä–∞–∂–∞–µ–º "Perfect" –∏ –¥–ª—è —Ä–∞—Å—á—ë—Ç–∞ –±–µ—Ä—ë–º DEATHS_FOR_CALC = 1.</li>
          <li><b>K A D</b> = (KILLS + ASSISTS) / DEATHS (DEATHS_FOR_CALC = 1 –ø—Ä–∏ DEATHS = 0).</li>
          <li><b>AVG</b> = KILLS / ROUNDS (–µ—Å–ª–∏ ROUNDS = 0 ‚Üí AVG = 0).</li>
          <li><b>SVR</b> = (ROUNDS ‚àí DEATHS) / ROUNDS √ó 100% (–µ—Å–ª–∏ ROUNDS = 0 ‚Üí SVR = 0%).</li>
          <li><b>WINRATE</b> = WINS / (WINS + LOSES) √ó 100% (–µ—Å–ª–∏ WINS+LOSES = 0 ‚Üí WINRATE = 0%).</li>
          <li><b>RATING</b> = –≤–∑–≤–µ—à–µ–Ω–Ω–∞—è —Å—É–º–º–∞ –Ω–æ—Ä–º–∞–ª–∏–∑–æ–≤–∞–Ω–Ω—ã—Ö –º–µ—Ç—Ä–∏–∫ √ó 100 (—Å–º. —Ä–µ–∞–ª–∏–∑–∞—Ü–∏—é –≤ –∫–æ–¥–µ).</li>
        </ol>
      </div>

      <hr style="margin:8px 0;border:none;height:8px">

      <div style="display:flex;gap:8px;flex-wrap:wrap">
        <button id="exportAll">–≠–∫—Å–ø–æ—Ä—Ç JSON</button>
        <button id="importAll">–ò–º–ø–æ—Ä—Ç JSON</button>
        <button id="clearAll" style="color:#ff7b7b">–û—á–∏—Å—Ç–∏—Ç—å –≤—Å—ë</button>
      </div>
    </aside>

    <footer>–ì–æ—Ç–æ–≤–æ: –¥–æ–±–∞–≤–ª–µ–Ω—ã –Ω–æ–º–∏–Ω–∞—Ü–∏–∏, —Ä–∞–Ω–≥–∏, –ø–µ—Ä–µ–∏–º–µ–Ω–æ–≤–∞–Ω–∏–µ, —Å—Ä–∞–≤–Ω–µ–Ω–∏–µ –∏ —Å–º–∞–π–ª–∏–∫–∏.</footer>
  </div>

<script>
/* ========== –ù–∞—Å—Ç—Ä–æ–π–∫–∏ —Ö—Ä–∞–Ω–µ–Ω–∏—è ========== */
const STORE = 'player_stats_v3';
const STORE_WEIGHTS = 'player_weights_v3';

/* –°—Ç—Ä—É–∫—Ç—É—Ä–∞ –∏–≥—Ä–æ–∫–∞:
{ id, name, kills, assists, deaths, rounds, wins, loses, createdAt, matches: [ {k,a,d,r,win,timestamp} ] }
WINS / LOSES = –º–∞—Ç—á–∏ (match wins / match loses)
*/

let players = [];
let selectedId = null;
let weights = { kd:30, kad:25, avg:20, svr:10, win:15 };
let uiState = { theme: (document.body.getAttribute('data-theme')||'dark') };

/* ---------- –£—Ç–∏–ª–∏—Ç—ã ---------- */
const $ = id => document.getElementById(id);
function uid(){ return 'p_' + Math.random().toString(36).slice(2,9); }
function save(){ 
  localStorage.setItem(STORE, JSON.stringify(players)); 
  localStorage.setItem(STORE_WEIGHTS, JSON.stringify(weights)); 
  localStorage.setItem('ui_state', JSON.stringify(uiState)); 
  renderList(); 
  renderSelected(); 
  renderNominations();
  populateCompareSelects(); // –æ–±–Ω–æ–≤–∏—Ç—å —Å–ø–∏—Å–∫–∏ —Å—Ä–∞–≤–Ω–µ–Ω–∏—è
}
function load(){ try{ const r = localStorage.getItem(STORE); const w = localStorage.getItem(STORE_WEIGHTS); const u = localStorage.getItem('ui_state'); players = r ? JSON.parse(r) : []; weights = w ? JSON.parse(w) : weights; if(u){ uiState = JSON.parse(u); document.body.setAttribute('data-theme', uiState.theme); } }catch(e){ console.error(e); players = []; } }

/* ---------- –§–æ—Ä–º—É–ª—ã (—Ä–µ–∞–ª–∏–∑–∞—Ü–∏—è —Ç–æ—á–Ω–æ –∫–∞–∫ –≤ –æ–ø–∏—Å–∞–Ω–∏–∏) ---------- */
function computeKD(p){
  const denom = p.deaths === 0 ? 1 : p.deaths;
  const value = denom === 0 ? 0 : p.kills / denom;
  const display = p.deaths === 0 ? 'Perfect' : value.toFixed(2);
  return { display, value };
}
function computeKAD(p){
  const denom = p.deaths === 0 ? 1 : p.deaths;
  const value = denom === 0 ? 0 : (p.kills + p.assists) / denom;
  return { display: value.toFixed(2), value };
}
function computeAVG(p){
  if(!p.rounds) return { display: '0.00', value: 0 };
  const value = p.kills / p.rounds;
  return { display: value.toFixed(2), value };
}
function computeSVR(p){
  if(!p.rounds) return { display: '0.0%', value: 0 };
  const surv = Math.max(0, p.rounds - p.deaths);
  const value = (surv / p.rounds) * 100;
  return { display: value.toFixed(1) + '%', value };
}
function computeWINRATE(p){
  const totalMatches = (p.wins || 0) + (p.loses || 0);
  if(totalMatches === 0) return { display: '0.0%', value: 0 };
  const value = p.wins / totalMatches;
  return { display: (value*100).toFixed(1) + '%', value };
}
function computeRATING(p){
  const kd = computeKD(p).value;
  const kad = computeKAD(p).value;
  const avg = computeAVG(p).value;
  const svr = computeSVR(p).value;
  const win = computeWINRATE(p).value;

  const kd_norm = Math.min(kd, 5) / 5;
  const kad_norm = Math.min(kad, 7) / 7;
  const avg_norm = Math.min(avg, 2) / 2;
  const svr_norm = Math.min(Math.max(svr, 0), 100) / 100;
  const win_norm = Math.min(Math.max(win, 0), 1);

  const sumW = (weights.kd + weights.kad + weights.avg + weights.svr + weights.win) || 1;
  const score = (weights.kd*kd_norm + weights.kad*kad_norm + weights.avg*avg_norm + weights.svr*svr_norm + weights.win*win_norm) / sumW;

  // –°–æ—Ö—Ä–∞–Ω—è–µ–º –ø–æ–≤–µ–¥–µ–Ω–∏–µ ‚Äî finalRating = score * 2 (–∫–∞–∫ –≤ –æ—Ä–∏–≥–∏–Ω–∞–ª–µ). –ù–µ –ª–æ–º–∞–µ–º –ª–æ–≥–∏–∫—É.
  const finalRating = score * 2;
  return { display: finalRating.toFixed(2), value: finalRating };
}

/* ---------- –†–ê–ù–ì–ò + –≠–ú–û–î–ó–ò ---------- */
function computeRankScore(p){
  const kd_norm = Math.min(computeKD(p).value, 5) / 5;
  const kad_norm = Math.min(computeKAD(p).value, 7) / 7;
  const avg_norm = Math.min(computeAVG(p).value, 2) / 2;
  const svr_norm = Math.min(Math.max(computeSVR(p).value, 0), 100) / 100;

  const sumW = (weights.kd + weights.kad + weights.avg + weights.svr) || 1;
  const score = (weights.kd*kd_norm + weights.kad*kad_norm + weights.avg*avg_norm + weights.svr*svr_norm) / sumW;
  return Math.round(score * 100);
}

function computeRank(p){
  const s = computeRankScore(p);
  if(s >= 90) return { id: 'global', name: 'Global', emoji: 'üåç', cls: 'rank-global' };
  if(s >= 75) return { id: 'emerald', name: 'Emerald', emoji: 'üü¢', cls: 'rank-emerald' };
  if(s >= 55) return { id: 'diamond', name: 'Diamond', emoji: 'üíé', cls: 'rank-diamond' };
  if(s >= 35) return { id: 'platinum', name: 'Platinum', emoji: '‚ö™', cls: 'rank-platinum' };
  if(s >= 20) return { id: 'gold', name: 'Gold', emoji: 'ü•á', cls: 'rank-gold' };
  return { id: 'silver', name: 'Silver', emoji: 'ü•à', cls: 'rank-silver' };
}

/* ---------- –ù–æ–º–∏–Ω–∞—Ü–∏–∏ ---------- */
function computeNominations(players){
  const res = {};
  if(!players.length) return res;
  let maxKills = -1, pidKills = null;
  let bestKD = -1, pidKD = null;
  let bestAVG = -1, pidAVG = null;
  let bestSingle = -1, pidSingle = null;
  let bestCons = Infinity, pidCons = null;
  let bestClutch = -1, pidClutch = null;

  players.forEach(p =>{
    if((p.kills||0) > maxKills){ maxKills = p.kills; pidKills = p.id; }
    const kd = computeKD(p).value; if(kd > bestKD){ bestKD = kd; pidKD = p.id; }
    const avg = computeAVG(p).value; if(avg > bestAVG){ bestAVG = avg; pidAVG = p.id; }

    const matches = p.matches || [];
    matches.forEach(m=>{ if(m.k > bestSingle){ bestSingle = m.k; pidSingle = p.id; } });

    if(matches.length >= 3){
      const arr = matches.map(m=>m.k);
      const mean = arr.reduce((a,b)=>a+b,0)/arr.length;
      const variance = arr.reduce((a,b)=>a + Math.pow(b-mean,2),0)/arr.length;
      const std = Math.sqrt(variance);
      if(std < bestCons){ bestCons = std; pidCons = p.id; }
    }

    const clutchCount = (matches||[]).filter(m=>m.k >= 10 && m.win).length;
    if(clutchCount > bestClutch){ bestClutch = clutchCount; pidClutch = p.id; }
  });

  res['Top Kills (all-time)'] = pidKills;
  res['Best KD (all-time)'] = pidKD;
  res['Best AVG (kills/round)'] = pidAVG;
  res['Best Single-Match Kills'] = pidSingle;
  if(pidCons) res['Most Consistent (œÉ low)'] = pidCons;
  res['Clutch King (10+ kills wins)'] = pidClutch;
  return res;
}

/* ---------- –†–µ–Ω–¥–µ—Ä —Å–ø–∏—Å–∫–∞ + —Ç–æ–ø + –Ω–æ–º–∏–Ω–∞—Ü–∏–∏ ---------- */
const playersList = $('playersList');
const countEl = $('count');

function renderList(){
  playersList.innerHTML = '';
  const q = $('searchInput').value.trim().toLowerCase();
  const sort = $('sortSelect').value;
  let filtered = players.filter(p => !q || p.name.toLowerCase().includes(q));
  if(sort === 'rating') filtered.sort((a,b)=> computeRATING(b).value - computeRATING(a).value);
  else if(sort === 'kills') filtered.sort((a,b)=> b.kills - a.kills);
  else if(sort === 'wins') filtered.sort((a,b)=> b.wins - a.wins);
  else filtered.sort((a,b)=> b.createdAt - a.createdAt);

  countEl.textContent = players.length;
  filtered.forEach(p=>{
    const rank = computeRank(p);
    const div = document.createElement('div');
    div.className = 'player-row' + (p.id === selectedId ? ' selected' : '');
    div.innerHTML = `
      <div style="min-width:0">
        <div style="display:flex;gap:8px;align-items:center">
          <div style="font-weight:700;white-space:nowrap;overflow:hidden;text-overflow:ellipsis">${escapeHtml(p.name)}</div>
          <div class="badge ${rank.cls}" title="–†–∞–Ω–≥: ${rank.name}">${rank.emoji} ${rank.name}</div>
        </div>
        <div class="small">K:${p.kills} A:${p.assists} D:${p.deaths} R:${p.rounds}</div>
        <div style="margin-top:6px"><small class="small">${p.matches && p.matches.length ? p.matches.length + ' –º–∞—Ç—á(–æ–≤) ‚Ä¢ ' : ''}–°–æ–∑–¥–∞–Ω: ${new Date(p.createdAt).toLocaleDateString()}</small></div>
      </div>
      <div style="display:flex;align-items:center;gap:8px">
        <div class="small" title="–†–µ–π—Ç–∏–Ω–≥">${computeRATING(p).display}</div>
        <div style="display:flex;flex-direction:column;gap:6px">
          <button data-id="${p.id}" data-act="open">–û—Ç–∫—Ä—ã—Ç—å</button>
          <button data-id="${p.id}" data-act="dup">–î—É–±–ª</button>
        </div>
      </div>
    `;
    playersList.appendChild(div);
  });

  renderTop3();
  renderNominations();
}

function renderTop3(){
  const top = [...players].sort((a,b)=> computeRATING(b).value - computeRATING(a).value).slice(0,3);
  const topList = $('topList'); topList.innerHTML = '';
  top.forEach((p,i)=>{
    const el = document.createElement('div'); el.className='card'; el.style.padding='8px'; el.style.flex='1';
    const rank = computeRank(p);
    el.innerHTML = `<div style="font-weight:700">#${i+1} ${escapeHtml(p.name)} <span class="badge ${rank.cls}" style="margin-left:8px">${rank.emoji} ${rank.name}</span></div><div class="small">R:${computeRATING(p).display} ‚Ä¢ K:${p.kills} W:${p.wins}</div>`;
    topList.appendChild(el);
  });
}

function renderNominations(){
  const list = $('nominationsList'); list.innerHTML = '';
  const nom = computeNominations(players);
  for(const title in nom){
    const pid = nom[title];
    const el = document.createElement('div'); el.style.display='flex'; el.style.justifyContent='space-between'; el.style.alignItems='center'; el.style.padding='6px'; el.style.borderRadius='6px'; el.style.background='rgba(255,255,255,0.01)';
    el.innerHTML = `<div class="small">${escapeHtml(title)}</div><div class="small">${pid ? escapeHtml((players.find(p=>p.id===pid)||{name:'?'}).name) : '‚Äî'}</div>`;
    list.appendChild(el);
  }
}

/* ---------- –í—ã–±–æ—Ä –∏ –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ –≤—ã–±—Ä–∞–Ω–Ω–æ–≥–æ ---------- */
function selectPlayer(id){ selectedId = id; renderList(); renderSelected(); }
function find(id){ return players.find(x=>x.id===id); }

function renderSelected(){
  const nameEl = $('selName'), infoEl = $('selInfo');
  if(!selectedId){ nameEl.textContent = '–ù–µ—Ç –≤—ã–±—Ä–∞–Ω–Ω–æ–≥–æ –∏–≥—Ä–æ–∫–∞'; infoEl.textContent = '–í—ã–±–µ—Ä–∏ —Å–ª–µ–≤–∞'; updateStatFieldsEmpty(); return; }
  const p = find(selectedId);
  if(!p){ selectedId = null; renderSelected(); return; }

  nameEl.textContent = p.name;
  infoEl.textContent = '–°–æ–∑–¥–∞–Ω: ' + new Date(p.createdAt).toLocaleString();

  const rank = computeRank(p);
  const selRank = $('selRank'); selRank.style.display='inline-block'; selRank.className = 'badge ' + rank.cls; selRank.textContent = rank.emoji + ' ' + rank.name;

  $('vKills').textContent = p.kills;
  $('vAssists').textContent = p.assists;
  $('vDeaths').textContent = p.deaths;
  $('vRounds').textContent = p.rounds;
  $('vWins').textContent = p.wins;
  $('vLoses').textContent = p.loses;

  $('vKD').textContent = computeKD(p).display;
  $('vKAD').textContent = computeKAD(p).display;
  $('vAVG').textContent = computeAVG(p).display;
  $('vSVR').textContent = computeSVR(p).display;
  $('vWINRATE').textContent = computeWINRATE(p).display;
  $('vRATING').textContent = computeRATING(p).display;

  const matches = p.matches || [];
  $('matchCount').textContent = '–ú–∞—Ç—á–µ–π: ' + matches.length;
  if(matches.length){
    $('historyCard').style.display = 'block';
    renderHistory(p);
  } else {
    $('historyCard').style.display = 'none';
  }
}
function updateStatFieldsEmpty(){ ['vKills','vAssists','vDeaths','vRounds','vWins','vLoses','vKD','vKAD','vAVG','vSVR','vWINRATE','vRATING'].forEach(id=>$(id).textContent='‚Äî'); $('selRank').style.display='none'; }

/* ---------- –°–æ–∑–¥–∞–Ω–∏–µ / –∏–∑–º–µ–Ω–µ–Ω–∏–µ ---------- */
$('addBtn').onclick = ()=>{
  const name = $('name').value.trim();
  if(!name) return alert('–í–≤–µ–¥–∏—Ç–µ –∏–º—è');
  const p = {
    id: uid(),
    name,
    kills: Math.max(0, Number($('kills').value) || 0),
    assists: Math.max(0, Number($('assists').value) || 0),
    deaths: Math.max(0, Number($('deaths').value) || 0),
    rounds: Math.max(0, Number($('rounds').value) || 0),
    wins: Math.max(0, Number($('wins').value) || 0),
    loses: Math.max(0, Number($('loses').value) || 0),
    matches: [],
    createdAt: Date.now()
  };
  players.unshift(p);
  selectedId = p.id;
  save();
  $('name').value = '';
  $('kills').value = 0;
  $('assists').value = 0;
  $('deaths').value = 0;
  $('rounds').value = 0;
  $('wins').value = 0;
  $('loses').value = 0;
};
$('addZeroBtn').onclick = ()=>{ const name = $('name').value.trim(); if(!name) return alert('–í–≤–µ–¥–∏—Ç–µ –∏–º—è'); const p = { id:uid(), name, kills:0, assists:0, deaths:0, rounds:0, wins:0, loses:0, matches:[], createdAt:Date.now() }; players.unshift(p); selectedId=p.id; save(); $('name').value=''; };

/* ---------- –ü–µ—Ä–µ–∏–º–µ–Ω–æ–≤–∞–Ω–∏–µ ---------- */
$('renamePlayer').onclick = ()=>{
  if(!selectedId) return alert('–í—ã–±–µ—Ä–∏—Ç–µ –∏–≥—Ä–æ–∫–∞');
  const p = find(selectedId);
  if(!p) return;
  const newName = prompt('–í–≤–µ–¥–∏—Ç–µ –Ω–æ–≤–æ–µ –∏–º—è', p.name);
  if(newName && newName.trim() !== '') {
    p.name = newName.trim();
    save();
  }
};

/* –î–µ–ª–µ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –∫–ª–∏–∫–æ–≤ –ø–æ —Å–ø–∏—Å–∫—É */
playersList.addEventListener('click', e=>{
  const btn = e.target.closest('button'); if(!btn) return;
  const id = btn.dataset.id; const act = btn.dataset.act;
  if(act === 'open') selectPlayer(id);
  if(act === 'dup'){ const p = find(id); if(!p) return; const copy = Object.assign({}, p, { id: uid(), name: p.name + '_copy', createdAt: Date.now() }); players.unshift(copy); save(); }
});

/* ---------- + / - –∏ –ø—Ä—è–º–æ–µ —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ ---------- */
document.querySelectorAll('[data-op]').forEach(b=> b.addEventListener('click', ()=> applyOp(b.getAttribute('data-op')) ) );

function applyOp(op){
  if(!selectedId){ alert('–í—ã–±–µ—Ä–∏ –∏–≥—Ä–æ–∫–∞'); return; }
  const p = find(selectedId); if(!p) return;
  switch(op){
    case 'k+': p.kills++; break;
    case 'k-': p.kills = Math.max(0,p.kills-1); break;
    case 'a+': p.assists++; break;
    case 'a-': p.assists = Math.max(0,p.assists-1); break;
    case 'd+': p.deaths++; break;
    case 'd-': p.deaths = Math.max(0,p.deaths-1); break;
    case 'r+': p.rounds++; break;
    case 'r-': p.rounds = Math.max(0,p.rounds-1); break;
    case 'w+': p.wins++; break;
    case 'w-': p.wins = Math.max(0,p.wins-1); break;
    case 'l+': p.loses++; break;
    case 'l-': p.loses = Math.max(0,p.loses-1); break;
  }
  save();
}

['editKills','editAssists','editDeaths','editRounds','editWins','editLoses'].forEach(id=>{
  const el = $(id); if(!el) return;
  el.onclick = ()=>{
    if(!selectedId){ alert('–í—ã–±–µ—Ä–∏ –∏–≥—Ä–æ–∫–∞'); return; }
    const p = find(selectedId); if(!p) return;
    const map = { editKills:'kills', editAssists:'assists', editDeaths:'deaths', editRounds:'rounds', editWins:'wins', editLoses:'loses' };
    const field = map[id];
    const v = prompt('–ù–æ–≤–æ–µ –∑–Ω–∞—á–µ–Ω–∏–µ –¥–ª—è ' + field.toUpperCase(), p[field]);
    if(v === null) return;
    p[field] = Math.max(0, parseInt(v) || 0);
    save();
  };
});

/* ---------- –£–¥–∞–ª–µ–Ω–∏–µ / —Å–±—Ä–æ—Å ---------- */
$('deletePlayer').onclick = ()=>{
  if(!selectedId) return alert('–ù–µ—Ç –≤—ã–±—Ä–∞–Ω–Ω–æ–≥–æ');
  if(!confirm('–£–¥–∞–ª–∏—Ç—å –∏–≥—Ä–æ–∫–∞?')) return;
  players = players.filter(x=>x.id !== selectedId);
  selectedId = players.length ? players[0].id : null;
  save();
};
$('resetPlayer').onclick = ()=>{
  if(!selectedId) return alert('–ù–µ—Ç –≤—ã–±—Ä–∞–Ω–Ω–æ–≥–æ');
  if(!confirm('–°–±—Ä–æ—Å–∏—Ç—å –≤—Å–µ —Å—á—ë—Ç—á–∏–∫–∏ —É –∏–≥—Ä–æ–∫–∞?')) return;
  const p = find(selectedId); if(!p) return;
  p.kills = p.assists = p.deaths = p.rounds = p.wins = p.loses = 0;
  p.matches = [];
  save();
};

/* ---------- –í–µ—Å–∞ (—Å–ª–∞–π–¥–µ—Ä—ã) ---------- */
['wKD','wKAD','wAVG','wSVR','wWIN'].forEach(id=>{
  const el = $(id);
  if(!el) return;
  el.oninput = ()=>{
    weights.kd = Number($('wKD').value);
    weights.kad = Number($('wKAD').value);
    weights.avg = Number($('wAVG').value);
    weights.svr = Number($('wSVR').value);
    weights.win = Number($('wWIN').value);
    save();
  };
});
$('resetWeights').onclick = ()=>{ weights = { kd:30, kad:25, avg:20, svr:10, win:15 }; $('wKD').value=30; $('wKAD').value=25; $('wAVG').value=20; $('wSVR').value=10; $('wWIN').value=15; save(); };

/* ---------- –≠–∫—Å–ø–æ—Ä—Ç / –∏–º–ø–æ—Ä—Ç / –æ—á–∏—Å—Ç–∫–∞ ---------- */
$('exportBtn').onclick = ()=>{
  const data = { players, weights };
  const blob = new Blob([JSON.stringify(data,null,2)], {type:'application/json'});
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a'); a.href = url; a.download = 'players_export.json'; document.body.appendChild(a); a.click(); a.remove(); URL.revokeObjectURL(url);
};
$('importBtn').onclick = ()=> $('importAll').click();
$('exportAll').onclick = $('exportBtn').onclick;
$('importAll').onclick = ()=>{
  const inp = document.createElement('input'); inp.type='file'; inp.accept='application/json';
  inp.onchange = async ()=>{ const f = inp.files[0]; if(!f) return; try{ const txt = await f.text(); const data = JSON.parse(txt); if(Array.isArray(data.players)) players = data.players; if(data.weights) weights = data.weights; selectedId = players.length ? players[0].id : null; save(); alert('–ò–º–ø–æ—Ä—Ç –∑–∞–≤–µ—Ä—à—ë–Ω'); }catch(e){ alert('–û—à–∏–±–∫–∞ –∏–º–ø–æ—Ä—Ç–∞'); console.error(e); } };
  inp.click();
};
$('clearAll').onclick = ()=>{
  if(!confirm('–£–Ω–∏—á—Ç–æ–∂–∏—Ç—å –≤—Å–µ –¥–∞–Ω–Ω—ã–µ (–ª–æ–∫–∞–ª—å–Ω–æ)?')) return;
  players = []; selectedId = null; weights = { kd:30,kad:25,avg:20,svr:10,win:15 }; localStorage.removeItem(STORE); localStorage.removeItem(STORE_WEIGHTS); save();
};

/* ---------- –¢–µ–º–∞ ---------- */
$('themeToggle').onclick = ()=>{ const cur = document.body.getAttribute('data-theme') || 'dark'; const next = cur === 'dark' ? 'light' : 'dark'; document.body.setAttribute('data-theme', next); uiState.theme = next; save(); };

/* ---------- –î–æ–±–∞–≤–ª–µ–Ω–∏–µ –º–∞—Ç—á–∞ ---------- */
$('addMatchBtn').onclick = ()=>{
  if(!selectedId) return alert('–í—ã–±–µ—Ä–∏ –∏–≥—Ä–æ–∫–∞');
  const k = parseInt(prompt('KILLS –≤ –º–∞—Ç—á–µ', '0')) || 0;
  const a = parseInt(prompt('ASSISTS –≤ –º–∞—Ç—á–µ', '0')) || 0;
  const d = parseInt(prompt('DEATHS –≤ –º–∞—Ç—á–µ', '0')) || 0;
  const r = parseInt(prompt('ROUNDS –≤ –º–∞—Ç—á–µ', '0')) || 0;
  const win = confirm('–ü–æ–±–µ–¥–∞ –≤ –º–∞—Ç—á–µ? (OK = –¥–∞, –û—Ç–º–µ–Ω–∞ = –Ω–µ—Ç)');
  const p = find(selectedId);
  if(!p) return;
  p.matches = p.matches || [];
  p.matches.push({ k,a,d,r,win: !!win, timestamp: Date.now() });
  p.kills += k; p.assists += a; p.deaths += d; p.rounds += r; if(win) p.wins++; else p.loses++;
  save();
};

$('clearHistory').onclick = ()=>{ if(!selectedId) return alert('–í—ã–±–µ—Ä–∏ –∏–≥—Ä–æ–∫–∞'); if(!confirm('–û—á–∏—Å—Ç–∏—Ç—å –∏—Å—Ç–æ—Ä–∏—é –º–∞—Ç—á–µ–π?')) return; const p=find(selectedId); if(!p) return; p.matches=[]; save(); };

function renderHistory(p){
  const list = $('historyList'); list.innerHTML='';
  const arr = (p.matches||[]).slice(-12).reverse();
  arr.forEach(m=>{
    const el = document.createElement('div'); el.className='small'; el.style.display='flex'; el.style.justifyContent='space-between'; el.style.alignItems='center'; el.style.padding='6px'; el.style.borderRadius='6px'; el.style.background='rgba(255,255,255,0.01)';
    el.innerHTML = `<div>K:${m.k} A:${m.a} D:${m.d} R:${m.r}</div><div>${m.win? 'W':'L'} ‚Ä¢ ${new Date(m.timestamp).toLocaleString()}</div>`;
    list.appendChild(el);
  });
  drawSpark(p.matches||[]);
}

function drawSpark(matches){
  const canvas = $('spark'); if(!canvas) return;
  const ctx = canvas.getContext('2d');
  const data = (matches||[]).slice(-24).map(m=>m.k);
  const w = canvas.clientWidth; const h = canvas.clientHeight;
  canvas.width = Math.round(w*devicePixelRatio); canvas.height = Math.round(h*devicePixelRatio);
  ctx.scale(devicePixelRatio, devicePixelRatio);
  ctx.clearRect(0,0,w,h);
  if(!data.length) return;
  const max = Math.max(...data); const min = Math.min(...data);
  const span = Math.max(1, max - min);
  ctx.lineWidth = 2; ctx.strokeStyle = getComputedStyle(document.body).getPropertyValue('--accent') || '#6ee7b7';
  ctx.beginPath();
  data.forEach((v,i)=>{
    const x = (i/(data.length-1 || 1))*(w-8)+4;
    const y = h - ((v - min) / span) * (h-8) - 4;
    if(i===0) ctx.moveTo(x,y); else ctx.lineTo(x,y);
  });
  ctx.stroke();
}

/* ---------- –°—Ä–∞–≤–Ω–µ–Ω–∏–µ –∏–≥—Ä–æ–∫–æ–≤ ---------- */
const compare1 = $('comparePlayer1');
const compare2 = $('comparePlayer2');
const compareBtn = $('compareBtn');
const compareResult = $('compareResult');

function populateCompareSelects(){
  if(!compare1 || !compare2) return;
  const options = players.map(p => `<option value="${p.id}">${escapeHtml(p.name)} (${computeRank(p).emoji})</option>`).join('');
  compare1.innerHTML = '<option value="">‚Äî –≤—ã–±–µ—Ä–∏—Ç–µ ‚Äî</option>' + options;
  compare2.innerHTML = '<option value="">‚Äî –≤—ã–±–µ—Ä–∏—Ç–µ ‚Äî</option>' + options;
}

function comparePlayers(){
  const id1 = compare1.value;
  const id2 = compare2.value;
  if(!id1 || !id2) return alert('–í—ã–±–µ—Ä–∏—Ç–µ –¥–≤—É—Ö –∏–≥—Ä–æ–∫–æ–≤');
  if(id1 === id2) return alert('–í—ã–±–µ—Ä–∏—Ç–µ —Ä–∞–∑–Ω—ã—Ö –∏–≥—Ä–æ–∫–æ–≤');
  const p1 = find(id1);
  const p2 = find(id2);
  if(!p1 || !p2) return;

  const metrics = [
    { label: 'KD', v1: computeKD(p1).value, v2: computeKD(p2).value, disp1: computeKD(p1).display, disp2: computeKD(p2).display },
    { label: 'KAD', v1: computeKAD(p1).value, v2: computeKAD(p2).value, disp1: computeKAD(p1).display, disp2: computeKAD(p2).display },
    { label: 'AVG', v1: computeAVG(p1).value, v2: computeAVG(p2).value, disp1: computeAVG(p1).display, disp2: computeAVG(p2).display },
    { label: 'SVR', v1: computeSVR(p1).value, v2: computeSVR(p2).value, disp1: computeSVR(p1).display, disp2: computeSVR(p2).display },
    { label: 'WINRATE', v1: computeWINRATE(p1).value, v2: computeWINRATE(p2).value, disp1: computeWINRATE(p1).display, disp2: computeWINRATE(p2).display },
    { label: 'RATING', v1: computeRATING(p1).value, v2: computeRATING(p2).value, disp1: computeRATING(p1).display, disp2: computeRATING(p2).display }
  ];

  let html = `<div style="display:flex; gap:20px; justify-content:space-between; font-weight:700; margin-bottom:8px;">
    <div>${escapeHtml(p1.name)}</div><div>${escapeHtml(p2.name)}</div>
  </div>`;

  metrics.forEach(m => {
    const better = m.v1 > m.v2 ? 'p1' : (m.v2 > m.v1 ? 'p2' : 'tie');
    html += `<div class="compare-metric">
      <span>${m.label}: <span class="${better === 'p1' ? 'better' : ''}">${m.disp1}</span></span>
      <span>${m.label}: <span class="${better === 'p2' ? 'better' : ''}">${m.disp2}</span></span>
    </div>`;
  });

  // –æ–±—â–∏–π –ø—Ä–æ—Ü–µ–Ω—Ç —Å–∏–ª—ã –Ω–∞ –æ—Å–Ω–æ–≤–µ rating
  const rating1 = computeRATING(p1).value;
  const rating2 = computeRATING(p2).value;
  const total = rating1 + rating2;
  const percent1 = total > 0 ? (rating1 / total * 100).toFixed(1) : 50;
  const percent2 = total > 0 ? (rating2 / total * 100).toFixed(1) : 50;
  html += `<div class="compare-metric" style="margin-top:8px; background:var(--glass);">
    <span class="better">${escapeHtml(p1.name)} —Å–∏–ª—å–Ω–µ–µ –Ω–∞ ${percent1}%</span>
    <span class="better">${escapeHtml(p2.name)} —Å–∏–ª—å–Ω–µ–µ –Ω–∞ ${percent2}%</span>
  </div>`;

  compareResult.innerHTML = html;
}

compareBtn.onclick = comparePlayers;
// –ø—Ä–∏ –∏–∑–º–µ–Ω–µ–Ω–∏–∏ players –æ–±–Ω–æ–≤–ª—è–µ–º —Å–ø–∏—Å–∫–∏
window.addEventListener('load', ()=>{
  populateCompareSelects();
});

/* ---------- –ú–∞–ª—ã–µ —É—Ç–∏–ª–∏—Ç—ã ---------- */
function escapeHtml(s){ return String(s).replace(/[&<>"]+/g, m => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;'}[m]||m)); }

/* ---------- –°–æ–±—ã—Ç–∏—è –ø–æ–∏—Å–∫–∞/—Å–æ—Ä—Ç–∏—Ä–æ–≤–∫–∏ ---------- */
$('searchInput').oninput = renderList; $('sortSelect').onchange = renderList;

/* ---------- –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è ---------- */
load();
if(players.length && !selectedId) selectedId = players[0].id;
renderList();
renderSelected();
populateCompareSelects();

// resize canvas
window.addEventListener('resize', ()=>{ if(selectedId){ const p=find(selectedId); if(p && p.matches && p.matches.length) drawSpark(p.matches); } });

</script>

<!-- === admin panel (–≤—Å—Ç–∞–≤–ª–µ–Ω –ø–æ—Å–ª–µ–¥–Ω–∏–º, –ø–µ—Ä–µ–¥ </body>) === -->
<script>
(function(){
  const ADMIN_KEY = 'is_admin_v3';
  const PASSWORD = '5ugaradmin'; // –ø–∞—Ä–æ–ª—å –¥–ª—è –≤–∫–ª—é—á–µ–Ω–∏—è –∞–¥–º–∏–Ω-—Å—Ç–∞—Ç—É—Å–∞

  function isAdmin(){ return localStorage.getItem(ADMIN_KEY) === '1'; }
  function setAdmin(on){
    localStorage.setItem(ADMIN_KEY, on ? '1' : '0');
    updateAdminUI();
  }

  function createAdminPanel(){
    const header = document.querySelector('header');
    if(!header) return;
    const wrapper = document.createElement('div');
    wrapper.id = 'adminPanelWrapper';
    wrapper.style.display = 'flex';
    wrapper.style.alignItems = 'center';
    wrapper.style.gap = '8px';
    wrapper.style.marginLeft = '12px';
    wrapper.innerHTML = `
      <div id="adminControls" style="display:flex;gap:8px;align-items:center">
        <div id="adminBadge" style="font-weight:700;display:none;color:#ffd27f">ADMIN</div>
        <button id="adminLoginBtn">–í–æ–π—Ç–∏ –∫–∞–∫ –∞–¥–º–∏–Ω</button>
        <button id="adminLogoutBtn" style="display:none">–í—ã–π—Ç–∏</button>
      </div>
    `;
    const target = header.querySelector('.controls') || header;
    target.appendChild(wrapper);

    document.getElementById('adminLoginBtn').addEventListener('click', ()=>{
      const pw = prompt('–í–≤–µ–¥–∏—Ç–µ –ø–∞—Ä–æ–ª—å –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞');
      if(pw === null) return;
      if(pw === PASSWORD){ setAdmin(true); alert('–ê–¥–º–∏–Ω –≤–∫–ª—é—á—ë–Ω'); }
      else alert('–ù–µ–≤–µ—Ä–Ω—ã–π –ø–∞—Ä–æ–ª—å');
    });
    document.getElementById('adminLogoutBtn').addEventListener('click', ()=>{ setAdmin(false); alert('–ê–¥–º–∏–Ω –≤—ã–∫–ª—é—á–µ–Ω'); });
  }

  function updateAdminUI(){
    const admin = isAdmin();
    const badge = document.getElementById('adminBadge');
    const loginBtn = document.getElementById('adminLoginBtn');
    const logoutBtn = document.getElementById('adminLogoutBtn');
    if(badge) badge.style.display = admin ? 'inline-block' : 'none';
    if(loginBtn) loginBtn.style.display = admin ? 'none' : 'inline-block';
    if(logoutBtn) logoutBtn.style.display = admin ? 'inline-block' : 'none';

    const protectedIds = [
      'addBtn','addZeroBtn','clearForm',
      'deletePlayer','resetPlayer','renamePlayer',
      'addMatchBtn','clearHistory',
      'clearAll',
      'wKD','wKAD','wAVG','wSVR','wWIN','resetWeights','exportAll'
    ];
    protectedIds.forEach(id=>{
      const el = document.getElementById(id);
      if(el) el.disabled = !admin;
    });

    document.querySelectorAll('[data-op]').forEach(b=> b.disabled = !admin);
    ['editKills','editAssists','editDeaths','editRounds','editWins','editLoses'].forEach(id=>{
      const el = document.getElementById(id);
      if(el) el.disabled = !admin;
    });

    document.querySelectorAll('#playersList button[data-act="dup"]').forEach(b=> b.disabled = !admin);

    ['wKD','wKAD','wAVG','wSVR','wWIN'].forEach(id=>{
      const el = document.getElementById(id);
      if(el) el.disabled = !admin;
    });

    document.querySelectorAll('button, input[type="range"]').forEach(el=>{
      if(el.disabled) el.title = '–¢—Ä–µ–±—É–µ—Ç—Å—è –∞–¥–º–∏–Ω —Å—Ç–∞—Ç—É—Å';
      else if(el.title === '–¢—Ä–µ–±—É–µ—Ç—Å—è –∞–¥–º–∏–Ω —Å—Ç–∞—Ç—É—Å') el.title = '';
    });
  }

  document.addEventListener('click', function(e){
    const btn = e.target.closest('button');
    if(!btn) return;
    if(btn.disabled){
      e.stopImmediatePropagation();
      e.preventDefault();
      if(!isAdmin()) {
        console.warn('–î–µ–π—Å—Ç–≤–∏–µ –∑–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω–æ ‚Äî —Ç—Ä–µ–±—É–µ—Ç—Å—è –∞–¥–º–∏–Ω —Å—Ç–∞—Ç—É—Å');
      }
    }
  }, true);

  createAdminPanel();
  updateAdminUI();

  window.__setAdmin = setAdmin;
})();
</script>
<!-- === /admin panel === -->

</body>
</html>
