<!doctype html>
<html lang="ru">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Трекер — HLTV-like Rating + Статистические звания (обновл.)</title>
<style>
  :root{
    --bg:#0b0b0b; --panel:#0f1113; --text:#e9eef8; --muted:#9aa3b2; --accent:#6ee7b7;
    --card:#141619; --radius:10px; --shadow: 0 8px 28px rgba(0,0,0,0.5);
    --glass: rgba(255,255,255,0.02);
  }
  *{box-sizing:border-box;font-family:Inter,system-ui,Segoe UI,Roboto,Arial;color:var(--text)}
  body{margin:0;background:linear-gradient(180deg,var(--bg),#07080a);min-height:100vh;padding:18px}
  .wrap{max-width:1200px;margin:0 auto;display:grid;grid-template-columns:320px 1fr 320px;gap:14px;align-items:start}
  header{grid-column:1/-1;display:flex;flex-wrap:wrap;justify-content:space-between;align-items:center;gap:8px;margin-bottom:6px}
  h1{font-size:18px;margin:0;color:var(--accent);letter-spacing:0.2px}
  .card{background:var(--card);padding:12px;border-radius:var(--radius);box-shadow:var(--shadow);border:1px solid rgba(255,255,255,0.03)}
  label{font-size:13px;color:var(--muted);display:block;margin-bottom:6px}
  input[type="text"],input[type="number"],select{width:100%;padding:8px;border-radius:8px;border:1px solid rgba(255,255,255,0.04);background:transparent;color:var(--text)}
  button{padding:8px 10px;border-radius:8px;border:1px solid rgba(255,255,255,0.04);background:transparent;color:var(--text);cursor:pointer}
  .players{display:flex;flex-direction:column;gap:8px;max-height:64vh;overflow:auto;margin-top:10px}
  .player-row{display:flex;justify-content:space-between;align-items:center;padding:12px;border-radius:8px;transition:all .18s ease;gap:12px}
  .player-row:hover{background:var(--glass); transform:translateY(-2px)}
  .player-row.selected{outline:2px solid rgba(255,255,255,0.03);background:linear-gradient(90deg, rgba(255,255,255,0.02), transparent)}
  .player-row.top{box-shadow:0 6px 24px rgba(196,140,255,0.08);border:1px solid rgba(196,140,255,0.08)}
  .player-row > .left { display:flex; gap:10px; align-items:center; min-width:0; flex:1 }
  .player-row > .right { flex:0 0 220px; display:flex; flex-direction:column; align-items:flex-end; gap:8px }
  .player-row .avatar { width:40px;height:40px;border-radius:8px;background:linear-gradient(180deg,rgba(255,255,255,0.02),transparent);display:flex;align-items:center;justify-content:center;font-weight:700;flex:0 0 40px }
  .mini .meta { display:flex; flex-direction:column; gap:4px; min-width:0 }
  .mini .meta .line { font-size:12px; color:var(--muted); white-space:nowrap; overflow:hidden; text-overflow:ellipsis }
  .stat-grid{display:grid;grid-template-columns:repeat(3,1fr);gap:10px;margin-top:10px}
  .stat{background:rgba(255,255,255,0.01);padding:12px;border-radius:8px;text-align:center}
  .small{font-size:13px;color:var(--muted)}
  .badge{padding:4px 10px;border-radius:999px;background:rgba(255,255,255,0.03);font-size:12px;font-weight:700}
  .muted-pill{padding:6px 8px;border-radius:999px;background:rgba(255,255,255,0.02);font-size:12px;color:var(--muted)}
  footer{grid-column:1/-1;text-align:center;color:var(--muted);margin-top:10px;font-size:13px}

  /* rank styles */
  .rank-silver{ background: linear-gradient(90deg, #9aa3b2, #87919b); color:#0b0b0b; }
  .rank-gold{   background: linear-gradient(90deg, #d7b354, #c49f3f); color:#111; }
  .rank-platinum{background: linear-gradient(90deg,#7fd1d8,#5fbfc6); color:#022;}
  .rank-emerald{ background: linear-gradient(90deg,#4dd47a,#2fb45f); color:#021;}
  .rank-global{ background: linear-gradient(90deg,#c48cff,#a86be6); color:#111;}
  .unranked{ background: rgba(255,255,255,0.02); color:var(--muted) }

  /* rank progress */
  .rank-progress{ height:8px; background: #111214; border-radius:8px; overflow:hidden; margin-top:4px; width:100% }
  .rank-progress-fill{ height:100%; width:0%; transition: width .6s ease; background: linear-gradient(90deg,#6ee7b7,#4dd47a); }

  /* responsive tweaks */
  @media (max-width:1100px){.wrap{grid-template-columns:1fr 360px;max-width:980px} aside:last-child{order:3} .player-row > .right{flex:0 0 180px}}
  @media (max-width:800px){.wrap{grid-template-columns:1fr;padding:12px} header{flex-direction:column;align-items:flex-start;gap:8px} .stat-grid{grid-template-columns:repeat(2,1fr)} .player-row{flex-direction:column;align-items:stretch} .player-row > .right{align-items:flex-start}} 
</style>
</head>
<body>
  <div class="wrap">
    <header>
      <div>
        <h1>Трекер — HLTV-like Rating + Статистические звания</h1>
        <div class="small">localStorage • Рейтинг округлён до 2 знаков • Ранги — по общей статистике</div>
      </div>
      <div style="display:flex;gap:8px;align-items:center;flex-wrap:wrap">
        <button id="btnRanks">Звания</button>
        <button id="btnNoms">Номинации</button>
        <button id="exportBtn">Экспорт</button>
        <button id="importBtn">Импорт</button>
      </div>
    </header>

    <!-- LEFT -->
    <aside class="card">
      <div style="display:flex;justify-content:space-between;align-items:center">
        <strong>Создать игрока</strong>
        <div class="small" id="count">0</div>
      </div>

      <div style="margin-top:8px">
        <label>Имя</label>
        <input id="inpName" type="text" placeholder="Никнейм">
      </div>

      <div style="display:grid;grid-template-columns:1fr 1fr;gap:8px;margin-top:8px">
        <div><label>KILLS</label><input id="inpKills" type="number" min="0" value="0"></div>
        <div><label>ASSISTS</label><input id="inpAssists" type="number" min="0" value="0"></div>
        <div><label>DEATHS</label><input id="inpDeaths" type="number" min="0" value="0"></div>
        <div><label>ROUNDS</label><input id="inpRounds" type="number" min="0" value="0"></div>
        <div><label>WINS</label><input id="inpWins" type="number" min="0" value="0"></div>
        <div><label>LOSES</label><input id="inpLoses" type="number" min="0" value="0"></div>
      </div>

      <div style="display:flex;gap:8px;margin-top:10px">
        <button id="btnAdd">Добавить</button>
        <button id="btnAddZero">Добавить (0)</button>
        <button id="btnClearForm">Сброс</button>
      </div>

      <hr style="margin:10px 0;border:none;height:8px">

      <div style="display:flex;justify-content:space-between;align-items:center">
        <strong>Поиск / Сорт</strong>
        <div class="small">клик: открыть</div>
      </div>

      <div style="display:flex;gap:8px;margin-top:8px">
        <input id="q" type="text" placeholder="Поиск по имени..." style="flex:1;padding:8px;border-radius:8px;border:1px solid rgba(255,255,255,0.04)">
        <select id="selSort" style="padding:8px;border-radius:8px;border:1px solid rgba(255,255,255,0.04)">
          <option value="created">Сначала новые</option>
          <option value="rating">По рейтингу</option>
          <option value="kills">По киллам</option>
          <option value="wins">По победам</option>
        </select>
      </div>

      <div class="players" id="playersList" style="margin-top:10px"></div>

      <div class="card" style="margin-top:10px">
        <div class="small"><strong>Номинации (кто что)</strong></div>
        <div id="nominationsList" style="margin-top:8px;display:flex;flex-direction:column;gap:6px"></div>
      </div>
    </aside>

    <!-- CENTER -->
    <main class="card">
      <div style="display:flex;justify-content:space-between;align-items:center;gap:12px;flex-wrap:wrap">
        <div>
          <div id="selName" style="font-weight:700">Нет выбранного</div>
          <div id="selMeta" class="small">Выберите игрока слева</div>
        </div>
        <div style="display:flex;gap:8px;align-items:center">
          <div id="selRank" class="badge unranked" style="display:inline-block">Unranked</div>
          <div id="selProgressWrap" style="min-width:220px;margin-left:8px"></div>
          <button id="btnRename">Переименовать</button>
          <button id="btnReset">Сброс</button>
          <button id="btnDelete" style="color:#ff7b7b">Удалить</button>
        </div>
      </div>

      <div class="stat-grid" style="margin-top:12px">
        <div class="stat">
          <div class="small">K</div><div id="vK" style="font-weight:700">—</div>
        </div>
        <div class="stat">
          <div class="small">A</div><div id="vA" style="font-weight:700">—</div>
        </div>
        <div class="stat">
          <div class="small">D</div><div id="vD" style="font-weight:700">—</div>
        </div>
        <div class="stat">
          <div class="small">R</div><div id="vR" style="font-weight:700">—</div>
        </div>
        <div class="stat">
          <div class="small">W</div><div id="vW" style="font-weight:700">—</div>
        </div>
        <div class="stat">
          <div class="small">L</div><div id="vL" style="font-weight:700">—</div>
        </div>
      </div>

      <div class="stat-grid" style="margin-top:12px">
        <div class="stat">
          <div class="small">KRP = K / R</div><div id="vKRP" style="font-weight:700">—</div>
        </div>
        <div class="stat">
          <div class="small">DPR = D / R</div><div id="vDPR" style="font-weight:700">—</div>
        </div>
        <div class="stat">
          <div class="small">Impact ≈ (K + 0.5·A) / R</div><div id="vImpact" style="font-weight:700">—</div>
        </div>
        <div class="stat" style="grid-column:1/-1">
          <div class="small">RATING (HLTV-like)</div><div id="vRating" style="font-weight:700;font-size:18px;margin-top:6px">—</div>
          <div class="small" style="margin-top:6px">Рейтинг показывает только при R > 0. Шкала ≈ 0.60 — 1.70.</div>
        </div>
      </div>

      <div style="display:flex;justify-content:space-between;align-items:center;margin-top:12px">
        <div class="small">История матчей (последние 12)</div>
        <div style="display:flex;gap:8px;align-items:center">
          <button id="btnAddMatch">Добавить матч</button>
          <div class="muted-pill" id="matchCount">Матчей: 0</div>
        </div>
      </div>

      <div id="history" style="margin-top:8px;display:flex;flex-direction:column;gap:6px;max-height:220px;overflow:auto"></div>
    </main>

    <!-- RIGHT -->
    <aside class="card">
      <div style="display:flex;justify-content:space-between;align-items:center">
        <strong>Параметры и экспорт</strong>
        <div style="display:flex;gap:8px;align-items:center">
          <button id="exportAll">Экспорт JSON</button>
          <button id="importAll">Импорт JSON</button>
          <button id="clearAll" style="color:#ff7b7b">Очистить всё</button>
        </div>
      </div>

      <div class="small" style="margin-top:10px;line-height:1.4">
        <div><b>KRP</b> = K / R</div>
        <div><b>DPR</b> = D / R</div>
        <div><b>Impact (approx)</b> = (K + 0.5·A) / R</div>
        <div style="margin-top:6px"><b>Rating (HLTV-like)</b> = нормализуем KRP/DPR/Impact и комбинируем:<br>
        rating ≈ 0.60 + score × 1.10, где score ∈ [0..1].</div>
      </div>
      <hr style="margin:10px 0;border:none;height:8px">
      <div><b>Пороги званий (по статистике) — облегчённая середина</b></div>
      <div class="small" style="margin-top:6px;line-height:1.4">
        Silver — 120 раундов, 100 киллов, K/D ≥ 0.80<br>
        Gold — 350 раундов, 300 киллов, K/D ≥ 0.95, WR ≥ 47%<br>
        Platinum — 700 раундов, 600 киллов, K/D ≥ 1.05, WR ≥ 51%, KRP ≥ 0.66<br>
        Emerald — 1100 раундов, 1000 киллов, K/D ≥ 1.15, WR ≥ 54%, KRP ≥ 0.72<br>
        Global — 1600 раундов, 1400 киллов, K/D ≥ 1.25, WR ≥ 58%, KRP ≥ 0.78
      </div>
    </aside>

    <footer>Готово: правки вёрстки + смягчённые пороги званий. Если нужно — могу ещё уменьшить ширину правого блока в списке или добавить switch «компактный/расширенный» вид.</footer>
  </div>

  <!-- MODALS (те же что и раньше) -->
  <div id="modalMatch" class="modal" style="display:none;position:fixed;inset:0;align-items:center;justify-content:center;background:rgba(0,0,0,0.6);z-index:2000">
    <div class="box card" style="width:420px;padding:14px">
      <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:8px">
        <strong>Добавить матч</strong><button id="closeMatch">✕</button>
      </div>
      <div style="display:grid;gap:8px">
        <label>KILLS <input id="m_k" type="number" min="0" value="0"></label>
        <label>ASSISTS <input id="m_a" type="number" min="0" value="0"></label>
        <label>DEATHS <input id="m_d" type="number" min="0" value="0"></label>
        <label>ROUNDS <input id="m_r" type="number" min="1" value="10"></label>
        <label><input id="m_win" type="checkbox"> Победа</label>
        <div style="display:flex;justify-content:flex-end;gap:8px">
          <button id="cancelMatch">Отмена</button>
          <button id="saveMatch">Добавить</button>
        </div>
      </div>
    </div>
  </div>

  <div id="modalRename" class="modal" style="display:none;position:fixed;inset:0;align-items:center;justify-content:center;background:rgba(0,0,0,0.6);z-index:2000">
    <div class="box card" style="width:380px;padding:14px">
      <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:8px">
        <strong>Переименовать игрока</strong><button id="closeRename">✕</button>
      </div>
      <div style="display:grid;gap:8px">
        <label>Новый ник <input id="newName" type="text"></label>
        <div style="display:flex;justify-content:flex-end;gap:8px">
          <button id="cancelRename">Отмена</button>
          <button id="saveRename">Сохранить</button>
        </div>
      </div>
    </div>
  </div>

  <div id="modalRanks" class="modal" style="display:none;position:fixed;inset:0;align-items:center;justify-content:center;background:rgba(0,0,0,0.6);z-index:2000">
    <div class="box card" style="width:740px;padding:14px">
      <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:8px">
        <strong>Звания — описание и владельцы</strong><button id="closeRanksModal">✕</button>
      </div>
      <div id="ranksContent" style="max-height:60vh;overflow:auto"></div>
    </div>
  </div>

  <div id="modalNoms" class="modal" style="display:none;position:fixed;inset:0;align-items:center;justify-content:center;background:rgba(0,0,0,0.6);z-index:2000">
    <div class="box card" style="width:740px;padding:14px">
      <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:8px">
        <strong>Номинации — текущие победители</strong><button id="closeNomsModal">✕</button>
      </div>
      <div id="nomsContent" style="max-height:60vh;overflow:auto"></div>
    </div>
  </div>

<script>
/* ========== State & storage (как раньше) */
const STORE_KEY = 'tracker_v_rewrite_v1';
const ADMIN_KEY = 'is_admin_v3';
const ADMIN_PASSWORD = '5ugaradmin';
let players = [];
let selectedId = null;
const $ = id => document.getElementById(id);

/* ---------- Persistence ---------- */
function load(){ try{ const txt = localStorage.getItem(STORE_KEY); players = txt ? JSON.parse(txt) : []; }catch(e){ console.error(e); players = []; } }
function save(){ localStorage.setItem(STORE_KEY, JSON.stringify(players)); renderList(); renderSelected(); }

/* ---------- Utils ---------- */
function uid(){ return 'p_' + Math.random().toString(36).slice(2,9); }
function escapeHtml(s){ return String(s).replace(/[&<>"]/g, c => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;'}[c])); }

/* ---------- Metrics ---------- */
function krp(p){ if(!p.rounds) return {value:null, display:'—'}; const v = p.kills / p.rounds; return {value:v, display:v.toFixed(3)}; }
function dpr(p){ if(!p.rounds) return {value:null, display:'—'}; const v = p.deaths / p.rounds; return {value:v, display:v.toFixed(3)}; }
function impactApprox(p){ if(!p.rounds) return {value:null, display:'—'}; const v = (p.kills + 0.5*(p.assists||0)) / p.rounds; return {value:v, display:v.toFixed(3)}; }
function normalize(v, expectedMax){ if(v === null) return 0; if(!isFinite(v)) return 0; return Math.max(0, Math.min(1, v / expectedMax)); }

/* Rating: rounded to 2 decimals */
function computeRating(p){
  if(!p.rounds) return { value:null, display:'—' };
  const kr = krp(p).value;
  const dr = dpr(p).value;
  const imp = impactApprox(p).value;
  const exp = 1.5;
  const nk = normalize(kr, exp);
  const nd = normalize(dr, exp);
  const ni = normalize(imp, exp);
  const wk = 0.40, wd = 0.20, wi = 0.40;
  const score = wk * nk + wd * (1 - nd) + wi * ni;
  const base = 0.60, scale = 1.10;
  let rating = base + score * scale;
  rating = Math.max(0, Math.min(2.0, rating));
  return { value: rating, display: rating.toFixed(2), components:{nk,nd,ni,score} };
}

/* ---------- Stat-based ranks (см. смягчённые пороги) ---------- */
const STAT_RANKS = [
  { id:'unranked', name:'Unranked', cls:'unranked', req: {} },
  { id:'silver', name:'Silver', cls:'rank-silver', req: { rounds:120, kills:100, kd:0.80 } },
  { id:'gold', name:'Gold', cls:'rank-gold', req: { rounds:350, kills:300, kd:0.95, winrate:0.47 } },
  { id:'platinum', name:'Platinum', cls:'rank-platinum', req: { rounds:700, kills:600, kd:1.05, winrate:0.51, krp:0.66 } },
  { id:'emerald', name:'Emerald', cls:'rank-emerald', req: { rounds:1100, kills:1000, kd:1.15, winrate:0.54, krp:0.72 } },
  { id:'global', name:'Global', cls:'rank-global', req: { rounds:1600, kills:1400, kd:1.25, winrate:0.58, krp:0.78 } }
];

function meetsRank(p, rankReq){
  if(!rankReq) return false;
  const rounds = p.rounds || 0;
  const kills = p.kills || 0;
  const deaths = p.deaths || 0;
  const wins = p.wins || 0;
  const loses = p.loses || 0;
  const kd = deaths ? kills / deaths : kills;
  const totalMatches = (wins||0) + (loses||0);
  const winrate = totalMatches ? wins / totalMatches : 0;
  const kr = rounds ? kills / rounds : 0;
  if('rounds' in rankReq && rounds < rankReq.rounds) return false;
  if('kills' in rankReq && kills < rankReq.kills) return false;
  if('kd' in rankReq && kd < rankReq.kd) return false;
  if('winrate' in rankReq && winrate < rankReq.winrate) return false;
  if('krp' in rankReq && kr < rankReq.krp) return false;
  return true;
}
function computeStatRank(p){
  let achievedIndex = 0;
  for(let i=1;i<STAT_RANKS.length;i++){
    if(meetsRank(p, STAT_RANKS[i].req)) achievedIndex = i;
  }
  const rank = STAT_RANKS[achievedIndex];
  const nextIndex = Math.min(achievedIndex+1, STAT_RANKS.length-1);
  const next = STAT_RANKS[nextIndex];
  if(rank.id === 'global') return { rank, next: null, progress: 100 };

  const req = next.req || {};
  const metrics = [];
  const rounds = p.rounds || 0;
  const kills = p.kills || 0;
  const deaths = p.deaths || 0;
  const wins = p.wins || 0;
  const loses = p.loses || 0;
  const kd = deaths ? kills / deaths : kills;
  const totalMatches = (wins||0) + (loses||0);
  const winrate = totalMatches ? wins / totalMatches : 0;
  const kr = rounds ? kills / rounds : 0;

  if('rounds' in req) metrics.push(Math.min(1, rounds / req.rounds));
  if('kills' in req) metrics.push(Math.min(1, kills / req.kills));
  if('kd' in req) metrics.push(Math.min(1, kd / req.kd));
  if('winrate' in req) metrics.push(Math.min(1, winrate / req.winrate));
  if('krp' in req) metrics.push(Math.min(1, kr / req.krp));

  const avg = metrics.length ? (metrics.reduce((a,b)=>a+b,0) / metrics.length) : 0;
  const progress = Math.round(Math.max(0, Math.min(1, avg)) * 100);
  return { rank, next, progress };
}

/* ---------- Nominations ---------- */
function computeNominations(){
  const res = {};
  if(!players.length) return res;
  let bestRating=-1, pidBestRating=null;
  let bestKD=-1, pidKD=null;
  let bestKRP=-1, pidKRP=null;
  let bestSingle=-1, pidSingle=null;
  let bestWin=-1, pidWin=null;
  let bestImpact=-Infinity, pidImpact=null;

  players.forEach(p=>{
    const r = computeRating(p).value;
    if(r !== null && r > bestRating){ bestRating = r; pidBestRating = p.id; }
    const kd = p.deaths ? p.kills / p.deaths : (p.kills || 0);
    if(kd > bestKD){ bestKD = kd; pidKD = p.id; }
    const kpr = p.rounds ? p.kills / p.rounds : 0;
    if(kpr > bestKRP){ bestKRP = kpr; pidKRP = p.id; }
    (p.matches||[]).forEach(m=>{ if(m.k > bestSingle){ bestSingle = m.k; pidSingle = p.id; }});
    const totalMatches = (p.wins||0) + (p.loses||0);
    if(totalMatches >= 3){
      const wr = (p.wins || 0) / totalMatches;
      if(wr > bestWin){ bestWin = wr; pidWin = p.id; }
    }
    const impactSum = (p.matches||[]).reduce((s,m)=> s + (m.k + 0.5*m.a - 0.3*m.d), 0);
    if(impactSum > bestImpact){ bestImpact = impactSum; pidImpact = p.id; }
  });

  res['Лучший рейтинг (тек.)'] = pidBestRating;
  res['Лучший K/D'] = pidKD;
  res['Лучший KRP (убийства/раунд)'] = pidKRP;
  res['Лучший матч (макс киллов)'] = pidSingle;
  res['Лучший винрейт (min 3 матча)'] = pidWin;
  res['Highest Impact (sum)'] = pidImpact;
  return res;
}

/* ---------- Rendering ---------- */
function renderList(){
  const container = $('playersList'); container.innerHTML = '';
  const qv = $('q').value.trim().toLowerCase();
  const sort = $('selSort').value;
  let list = players.filter(p => !qv || p.name.toLowerCase().includes(qv));

  if(sort === 'rating') list.sort((a,b)=> {
    const ra = computeRating(a).value || -1;
    const rb = computeRating(b).value || -1;
    return rb - ra;
  });
  else if(sort === 'kills') list.sort((a,b)=> b.kills - a.kills);
  else if(sort === 'wins') list.sort((a,b)=> b.wins - a.wins);
  else list.sort((a,b)=> b.createdAt - a.createdAt);

  $('count').textContent = players.length;

  const topByRating = [...players].filter(p=> computeRating(p).value !== null).sort((a,b)=> computeRating(b).value - computeRating(a).value)[0];
  const topId = topByRating ? topByRating.id : null;

  list.forEach(p=>{
    const rating = computeRating(p);
    const statRank = computeStatRank(p);
    const rank = statRank.rank;
    const progress = statRank.next ? statRank.progress : 100;

    const div = document.createElement('div');
    div.className = 'player-row' + (p.id === selectedId ? ' selected' : '') + (p.id === topId ? ' top' : '');
    div.innerHTML = `
      <div class="left">
        <div class="avatar">${escapeHtml((p.name||'').slice(0,2).toUpperCase())}</div>
        <div class="mini">
          <div style="display:flex;gap:8px;align-items:center">
            <div style="font-weight:700;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;max-width:200px">${escapeHtml(p.name)}</div>
            <div class="badge ${rank.cls}">${rank.name}</div>
          </div>
          <div class="meta">
            <div class="line">R:${p.rounds || 0} • K:${p.kills || 0} • D:${p.deaths || 0}</div>
            <div class="line">Rtg: ${rating.value===null? '—': rating.display} • K/D: ${p.deaths ? (p.kills / p.deaths).toFixed(2) : '—'} • WR: ${computeWinRatePercent(p)}</div>
          </div>
        </div>
      </div>
      <div class="right">
        <div class="small">${rating.value===null ? '—' : rating.display}</div>
        <div style="width:100%;margin-top:6px" title="Прогресс до следующего ранга">
          <div class="rank-progress"><div class="rank-progress-fill" style="width:${progress}%"></div></div>
          <div class="small" style="margin-top:6px;text-align:right">${progress}% до ${statRank.next ? statRank.next.name : 'макс'}</div>
        </div>
        <div style="display:flex;gap:6px;margin-top:6px">
          <button data-id="${p.id}" data-act="open">Открыть</button>
          <button data-id="${p.id}" data-act="dup">Дубл</button>
        </div>
      </div>
    `;
    container.appendChild(div);
  });

  renderTop3();
  renderNominations();
}

function renderTop3(){
  const existing = document.getElementById('topList'); if(existing) existing.remove();
  const top = [...players].filter(p=> computeRating(p).value !== null).sort((a,b)=> computeRating(b).value - computeRating(a).value).slice(0,3);
  if(!top.length) return;
  let topBox = document.createElement('div'); topBox.id = 'topList'; topBox.className = 'card'; topBox.style.marginTop='10px'; topBox.style.padding='8px'; topBox.style.display='flex'; topBox.style.gap='8px';
  top.forEach((p,i)=>{
    const r = computeRating(p).display;
    const statRank = computeStatRank(p);
    const rank = statRank.rank;
    const div = document.createElement('div'); div.className='card'; div.style.padding='8px'; div.style.flex='1';
    div.innerHTML = `<div style="font-weight:700">#${i+1} ${escapeHtml(p.name)} <span class="badge ${rank.cls}" style="margin-left:8px">${rank.name}</span></div><div class="small">R:${p.rounds} • Rtg:${r} • K/D:${p.deaths? (p.kills/p.deaths).toFixed(2):'—'}</div>`;
    topBox.appendChild(div);
  });
  document.querySelector('aside.card').appendChild(topBox);
}

function renderNominations(){
  const dom = $('nominationsList'); if(!dom) return;
  dom.innerHTML = '';
  const noms = computeNominations();
  for(const key in noms){
    const pid = noms[key];
    const name = pid ? (players.find(p=>p.id===pid)?.name || '?') : '—';
    const row = document.createElement('div');
    row.style.display='flex'; row.style.justifyContent='space-between'; row.style.alignItems='center'; row.style.padding='6px'; row.style.borderRadius='6px'; row.style.background='rgba(255,255,255,0.01)';
    row.innerHTML = `<div class="small">${escapeHtml(key)}</div><div class="small">${escapeHtml(name)}</div>`;
    dom.appendChild(row);
  }
}

function renderSelected(){
  const sel = selectedId ? players.find(p=>p.id===selectedId) : null;
  if(!sel){ $('selName').textContent = 'Нет выбранного'; $('selMeta').textContent = 'Выберите игрока слева'; updateSelectedFieldsEmpty(); return; }
  $('selName').textContent = sel.name;
  $('selMeta').textContent = 'Создан: ' + new Date(sel.createdAt).toLocaleString();
  $('vK').textContent = sel.kills;
  $('vA').textContent = sel.assists;
  $('vD').textContent = sel.deaths;
  $('vR').textContent = sel.rounds;
  $('vW').textContent = sel.wins;
  $('vL').textContent = sel.loses;

  const k = krp(sel); $('vKRP').textContent = k.display;
  const d = dpr(sel); $('vDPR').textContent = d.display;
  const imp = impactApprox(sel); $('vImpact').textContent = imp.display;
  const rating = computeRating(sel); $('vRating').textContent = rating.display;

  const statRank = computeStatRank(sel);
  const rank = statRank.rank;
  const progress = statRank.next ? statRank.progress : 100;
  const selRank = $('selRank'); selRank.textContent = rank.name; selRank.className = 'badge ' + rank.cls;

  const wrap = $('selProgressWrap');
  if(statRank.next){
    wrap.innerHTML = `<div style="font-size:12px;color:var(--muted)">${progress}% до ${statRank.next.name}</div>
      <div class="rank-progress" style="width:220px"><div class="rank-progress-fill" style="width:${progress}%"></div></div>`;
  } else {
    wrap.innerHTML = `<div style="font-size:12px;color:var(--muted)">Достигнут верхний ранг</div>`;
  }

  const hist = $('history'); hist.innerHTML = '';
  const arr = (sel.matches||[]).slice(-12).reverse();
  arr.forEach(m=>{
    const item = document.createElement('div'); item.className='small';
    item.style.display='flex'; item.style.justifyContent='space-between'; item.style.alignItems='center'; item.style.padding='6px'; item.style.borderRadius='6px'; item.style.background='rgba(255,255,255,0.01)';
    item.innerHTML = `<div>K:${m.k} A:${m.a} D:${m.d} R:${m.r}</div><div>${m.win? 'W':'L'} • ${new Date(m.ts).toLocaleString()}</div>`;
    hist.appendChild(item);
  });
  $('matchCount').textContent = 'Матчей: ' + (sel.matches?.length || 0);
}

function updateSelectedFieldsEmpty(){
  ['vK','vA','vD','vR','vW','vL','vKRP','vDPR','vImpact','vRating'].forEach(id=>$(id).textContent='—');
  $('selRank').textContent = 'Unranked'; $('selRank').className='badge unranked';
  $('selProgressWrap').innerHTML = '';
  $('history').innerHTML=''; $('matchCount').textContent = 'Матчей: 0';
}

/* ---------- Helpers ---------- */
function computeWinRatePercent(p){
  const wins = p.wins || 0; const loses = p.loses || 0;
  const t = wins + loses; if(t === 0) return '—'; return Math.round((wins / t) * 100) + '%';
}

/* ---------- Events: create/edit/delete (admin checks preserved) ---------- */
function isAdmin(){ return localStorage.getItem(ADMIN_KEY) === '1'; }
function setAdmin(on){ localStorage.setItem(ADMIN_KEY, on ? '1' : '0'); updateAdminUI(); }
function createAdminPanel(){
  const header = document.querySelector('header'); if(!header) return;
  const wrapper = document.createElement('div'); wrapper.style.display='flex'; wrapper.style.gap='8px'; wrapper.style.alignItems='center';
  wrapper.innerHTML = `<div id="adminBadge" style="font-weight:700;display:none;color:#ffd27f">ADMIN</div><button id="adminLoginBtn">Войти как админ</button><button id="adminLogoutBtn" style="display:none">Выйти</button>`;
  header.appendChild(wrapper);
  document.getElementById('adminLoginBtn').addEventListener('click', ()=>{ const pw = prompt('Введите пароль администратора'); if(pw === null) return; if(pw === ADMIN_PASSWORD){ setAdmin(true); alert('Админ включён'); } else alert('Неверный пароль'); });
  document.getElementById('adminLogoutBtn').addEventListener('click', ()=>{ setAdmin(false); alert('Админ выключен'); });
}
function updateAdminUI(){
  const admin = isAdmin();
  const badge = document.getElementById('adminBadge');
  const loginBtn = document.getElementById('adminLoginBtn');
  const logoutBtn = document.getElementById('adminLogoutBtn');
  if(badge) badge.style.display = admin ? 'inline-block' : 'none';
  if(loginBtn) loginBtn.style.display = admin ? 'none' : 'inline-block';
  if(logoutBtn) logoutBtn.style.display = admin ? 'inline-block' : 'none';

  const protectedIds = ['btnAdd','btnAddZero','btnClearForm','btnDelete','btnReset','btnAddMatch','saveMatch','cancelMatch','clearAll','exportAll','importAll'];
  protectedIds.forEach(id=>{ const el = document.getElementById(id); if(el) el.disabled = !admin; });
  document.querySelectorAll('#playersList button[data-act="dup"]').forEach(b=> b.disabled = !admin);
}

/* Attach events (most same as before) */
createAdminPanel(); updateAdminUI();

document.getElementById('btnAdd').addEventListener('click', ()=>{
  if(!isAdmin()) return alert('Требуется админ статус для добавления — войдите как админ.');
  const name = $('inpName').value.trim(); if(!name) return alert('Введите имя');
  const p = { id: uid(), name, kills: Math.max(0, parseInt($('inpKills').value)||0), assists: Math.max(0, parseInt($('inpAssists').value)||0), deaths: Math.max(0, parseInt($('inpDeaths').value)||0), rounds: Math.max(0, parseInt($('inpRounds').value)||0), wins: Math.max(0, parseInt($('inpWins').value)||0), loses: Math.max(0, parseInt($('inpLoses').value)||0), matches: [], createdAt: Date.now() };
  players.unshift(p); selectedId = p.id; ['inpName','inpKills','inpAssists','inpDeaths','inpRounds','inpWins','inpLoses'].forEach(id=>$(id).value = (id==='inpName'?'':'0')); save();
});
document.getElementById('btnAddZero').addEventListener('click', ()=>{ if(!isAdmin()) return alert('Требуется админ статус для добавления.'); const name = $('inpName').value.trim(); if(!name) return alert('Введите имя'); const p = { id:uid(), name, kills:0, assists:0, deaths:0, rounds:0, wins:0, loses:0, matches:[], createdAt: Date.now() }; players.unshift(p); selectedId = p.id; $('inpName').value=''; save(); });
document.getElementById('btnClearForm').addEventListener('click', ()=> { ['inpName','inpKills','inpAssists','inpDeaths','inpRounds','inpWins','inpLoses'].forEach(id=> $(id).value = id==='inpName' ? '' : '0'); });

document.getElementById('playersList').addEventListener('click', e=>{
  const btn = e.target.closest('button'); if(!btn) return;
  const id = btn.dataset.id; const act = btn.dataset.act;
  if(act === 'open') { selectedId = id; renderSelected(); renderList(); }
  if(act === 'dup'){ if(!isAdmin()) return alert('Требуется админ статус для дублирования записи.'); const origin = players.find(p=>p.id===id); if(!origin) return; const copy = JSON.parse(JSON.stringify(origin)); copy.id = uid(); copy.name = origin.name + '_copy'; copy.createdAt = Date.now(); players.unshift(copy); save(); }
});

document.getElementById('btnDelete').addEventListener('click', ()=>{ if(!isAdmin()) return alert('Требуется админ статус для удаления.'); if(!selectedId) return alert('Нет выбранного'); if(!confirm('Удалить игрока?')) return; players = players.filter(p=>p.id !== selectedId); selectedId = players.length ? players[0].id : null; save(); });
document.getElementById('btnReset').addEventListener('click', ()=>{ if(!isAdmin()) return alert('Требуется админ статус для сброса.'); if(!selectedId) return alert('Нет выбранного'); if(!confirm('Сбросить счётчики?')) return; const p = players.find(x=>x.id===selectedId); if(!p) return; p.kills = p.assists = p.deaths = p.rounds = p.wins = p.loses = 0; p.matches = []; save(); });

document.getElementById('btnRename').addEventListener('click', ()=>{ if(!selectedId) return alert('Выберите игрока'); const p = players.find(x=>x.id===selectedId); if(!p) return; $('newName').value = p.name; showModal('modalRename'); });
document.getElementById('saveRename').addEventListener('click', ()=>{ const v = $('newName').value.trim(); if(!v) return alert('Имя не может быть пустым'); const p = players.find(x=>x.id===selectedId); if(!p) return; p.name = v; save(); closeModal('modalRename'); });
document.getElementById('cancelRename').addEventListener('click', ()=> closeModal('modalRename')); document.getElementById('closeRename').addEventListener('click', ()=> closeModal('modalRename'));

document.getElementById('btnAddMatch').addEventListener('click', ()=>{ if(!isAdmin()) return alert('Требуется админ статус для добавления матча.'); if(!selectedId) return alert('Выберите игрока'); $('m_k').value = 0; $('m_a').value = 0; $('m_d').value = 0; $('m_r').value = Math.max(1, $('inpRounds').value || 10); $('m_win').checked = true; showModal('modalMatch'); });
document.getElementById('saveMatch').addEventListener('click', ()=>{ if(!isAdmin()) return alert('Требуется админ статус для добавления матча.'); if(!selectedId) return alert('Выберите игрока'); const k = Math.max(0, parseInt($('m_k').value)||0); const a = Math.max(0, parseInt($('m_a').value)||0); const d = Math.max(0, parseInt($('m_d').value)||0); const r = Math.max(1, parseInt($('m_r').value)||1); const win = !!$('m_win').checked; const p = players.find(x=>x.id===selectedId); if(!p) return; p.matches = p.matches || []; p.matches.push({ k,a,d,r,win,ts:Date.now() }); p.kills = (p.kills||0) + k; p.assists = (p.assists||0) + a; p.deaths = (p.deaths||0) + d; p.rounds = (p.rounds||0) + r; if(win) p.wins = (p.wins||0) + 1; else p.loses = (p.loses||0) + 1; save(); closeModal('modalMatch'); });
document.getElementById('cancelMatch').addEventListener('click', ()=> closeModal('modalMatch')); document.getElementById('closeMatch').addEventListener('click', ()=> closeModal('modalMatch'));

/* modal helpers */
function showModal(id){ $(id).style.display = 'flex'; }
function closeModal(id){ $(id).style.display = 'none'; }

/* export/import */
function exportAllHandler(){ const blob = new Blob([JSON.stringify({players},null,2)], {type:'application/json'}); const url = URL.createObjectURL(blob); const a = document.createElement('a'); a.href = url; a.download = 'tracker_export.json'; document.body.appendChild(a); a.click(); a.remove(); URL.revokeObjectURL(url); }
function importAllHandler(){ const inp = document.createElement('input'); inp.type='file'; inp.accept='application/json'; inp.onchange = async ()=> { const f = inp.files[0]; if(!f) return; try{ const txt = await f.text(); const json = JSON.parse(txt); if(Array.isArray(json.players)) players = json.players; selectedId = players.length ? players[0].id : null; save(); alert('Импорт завершён'); }catch(e){ console.error(e); alert('Ошибка импорта'); } }; inp.click(); }
document.getElementById('exportBtn').addEventListener('click', exportAllHandler);
document.getElementById('importBtn').addEventListener('click', importAllHandler);
document.getElementById('exportAll').addEventListener('click', exportAllHandler);
document.getElementById('importAll').addEventListener('click', importAllHandler);

document.getElementById('clearAll').addEventListener('click', ()=>{ if(!isAdmin()) return alert('Требуется админ статус для очистки данных.'); if(!confirm('Уничтожить все данные (локально)?')) return; players = []; selectedId = null; localStorage.removeItem(STORE_KEY); save(); });

document.getElementById('btnRanks').addEventListener('click', ()=> {
  const root = $('ranksContent'); root.innerHTML = '';
  STAT_RANKS.forEach((r)=>{
    if(r.id === 'unranked') return;
    const node = document.createElement('div'); node.style.padding='8px'; node.style.borderBottom='1px solid rgba(255,255,255,0.03)';
    const playersWith = players.filter(p=> meetsRank(p, r.req)).map(p=>escapeHtml(p.name)).join(', ') || '—';
    node.innerHTML = `<div style="display:flex;justify-content:space-between"><div style="font-weight:700">${r.name}</div><div class="small">Требования: ${JSON.stringify(r.req)}</div></div><div class="small" style="margin-top:6px">Игроки: ${playersWith}</div>`;
    root.appendChild(node);
  });
  showModal('modalRanks');
});
document.getElementById('closeRanksModal').addEventListener('click', ()=> closeModal('modalRanks'));

document.getElementById('btnNoms').addEventListener('click', ()=> {
  const root = $('nomsContent'); root.innerHTML = '';
  const defs = {
    'Лучший рейтинг (тек.)':'Игрок с наивысшим рейтингом (HLTV-like).',
    'Лучший K/D':'Наибольшее K/D.',
    'Лучший KRP':'Лучшее K / R.',
    'Лучший матч (киллы)':'Максимум киллов в одной записи match.',
    'Лучший винрейт (min 3)':'Лучший W/(W+L) при минимум 3 матчах.',
    'Highest Impact (sum)':'Наибольшая суммарная «влияния» по матчам.'
  };
  const noms = computeNominations();
  for(const key in defs){
    const pid = noms[key];
    const name = pid ? players.find(p=>p.id===pid)?.name || '?' : '—';
    const node = document.createElement('div'); node.style.padding='8px'; node.style.borderBottom='1px solid rgba(255,255,255,0.03)';
    node.innerHTML = `<div style="display:flex;justify-content:space-between"><div style="font-weight:700">${escapeHtml(key)}</div><div class="small">${escapeHtml(name)}</div></div><div class="small" style="margin-top:6px">${escapeHtml(defs[key])}</div>`;
    root.appendChild(node);
  }
  showModal('modalNoms');
});
document.getElementById('closeNomsModal').addEventListener('click', ()=> closeModal('modalNoms'));

/* search/sort live */
document.getElementById('q').addEventListener('input', renderList);
document.getElementById('selSort').addEventListener('change', renderList);

/* open row by click (not on buttons) */
document.querySelector('aside.card').addEventListener('click', e=>{
  const row = e.target.closest('.player-row');
  if(row && !e.target.closest('button')){
    const nameElem = row.querySelector('.mini > div[style]') || row.querySelector('.mini div');
    if(!nameElem) return;
    const name = nameElem.textContent.trim().split('\n')[0].trim();
    const p = players.find(x=> x.name === name);
    if(p){ selectedId = p.id; renderSelected(); renderList(); }
  }
});

/* ---------- Init ---------- */
load();
if(players.length) selectedId = players[0].id;
renderList();
renderSelected();
</script>
</body>
</html>
