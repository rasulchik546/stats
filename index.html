<!doctype html>
<html lang="ru">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Статистический трекер — K/A/D/W/L/ROUNDS — HLTV-like Rating</title>
<style>
  :root{
    --bg:#0b0b0b; --panel:#0f1113; --text:#e9eef8; --muted:#9aa3b2; --accent:#6ee7b7; --glass: rgba(255,255,255,0.03);
    --card-shadow: 0 6px 18px rgba(0,0,0,0.45);
    --radius:12px;
  }
  [data-theme="light"]{ --bg:#f6f8fa; --panel:#ffffff; --text:#0b1220; --muted:#556270; --accent:#0f766e; --glass: rgba(10,10,10,0.03); }
  *{box-sizing:border-box;font-family:Inter,ui-sans-serif,system-ui,-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,"Helvetica Neue",Arial}
  html,body{height:100%;margin:0;background:linear-gradient(180deg,var(--bg),#07080a);color:var(--text);-webkit-font-smoothing:antialiased}
  .wrap{max-width:1200px;margin:18px auto;padding:16px;display:grid;grid-template-columns:320px 1fr 320px;gap:14px}
  header{grid-column:1/-1;display:flex;justify-content:space-between;align-items:center;margin-bottom:6px}
  h1{font-size:18px;margin:0;color:var(--accent)}
  .card{background:linear-gradient(180deg,var(--panel),rgba(255,255,255,0.01));padding:14px;border-radius:var(--radius);box-shadow:var(--card-shadow);border:1px solid rgba(255,255,255,0.03)}
  label{font-size:13px;color:var(--muted);display:block;margin-bottom:6px}
  input[type="text"],input[type="number"],select{width:100%;padding:10px;border-radius:10px;border:1px solid rgba(255,255,255,0.04);background:transparent;color:var(--text);font-size:14px}
  .players{display:flex;flex-direction:column;gap:8px;max-height:64vh;overflow:auto;margin-top:10px}
  .player-row{display:flex;justify-content:space-between;align-items:center;padding:10px;border-radius:10px}
  .player-row:hover{background:var(--glass)}
  .player-row.selected{outline:2px solid rgba(255,255,255,0.04);background:linear-gradient(90deg, rgba(255,255,255,0.02), transparent)}
  .stat-grid{display:grid;grid-template-columns:repeat(3,1fr);gap:10px;margin-top:10px}
  .stat{background:rgba(255,255,255,0.01);padding:12px;border-radius:10px;text-align:center}
  .ops{display:flex;gap:6px;justify-content:center;margin-top:8px}
  .hotbar{display:flex;justify-content:space-between;align-items:center;padding:10px;margin-top:10px;border-radius:8px;background:rgba(255,255,255,0.01)}
  button{padding:8px 10px;border-radius:8px;border:1px solid rgba(255,255,255,0.04);background:transparent;color:var(--text);cursor:pointer}
  .small{font-size:13px;color:var(--muted)}
  footer{grid-column:1/-1;text-align:center;color:var(--muted);margin-top:10px;font-size:13px}
  .controls{display:flex;gap:8px;align-items:center}
  .search{display:flex;gap:8px;margin-top:10px}
  .flex{display:flex;gap:8px}
  .leader{display:flex;flex-direction:column;gap:8px;margin-top:10px}
  canvas.spark{width:100%;height:40px;border-radius:6px;display:block}
  .muted-pill{padding:6px 8px;border-radius:999px;background:rgba(255,255,255,0.02);font-size:12px;color:var(--muted)}
  .badge{padding:4px 8px;border-radius:999px;background:rgba(255,255,255,0.03);font-size:12px}
  .rank-silver{background:linear-gradient(90deg,#c0c0c0,#b0b0b0);color:#111}
  .rank-gold{background:linear-gradient(90deg,#ffd27f,#f6c85f);color:#111}
  .rank-platinum{background:linear-gradient(90deg,#cfeaf5,#9ad3e8);color:#111}
  .rank-diamond{background:linear-gradient(90deg,#b7e0ff,#8fcfff);color:#011}
  .rank-emerald{background:linear-gradient(90deg,#7bf0b3,#4edc93);color:#012}
  .rank-global{background:linear-gradient(90deg,#ffd3ff,#ffb7f0);color:#111}

  .modal { position: fixed; inset:0; display:none; align-items:center; justify-content:center; background:rgba(0,0,0,0.55); z-index:9999; }
  .modal .box { width:min(880px,96%); max-height:80vh; overflow:auto; background:var(--panel); padding:18px; border-radius:12px; border:1px solid rgba(255,255,255,0.03); }
  .formula { font-family:monospace; font-size:13px; color:var(--muted); margin-top:6px; }

  @media (max-width:1100px){.wrap{grid-template-columns:1fr 360px;max-width:980px} aside:last-child{order:3} }
  @media (max-width:800px){.wrap{grid-template-columns:1fr;padding:12px} header{flex-direction:column;align-items:flex-start;gap:8px} .players{max-height:36vh} .stat-grid{grid-template-columns:repeat(2,1fr)} }
</style>
</head>
<body data-theme="dark">
  <div class="wrap">
    <header>
      <div>
        <h1>Трекер игроков — K/A/D / MATCH W/L / ROUNDS — HLTV-like</h1>
        <div class="small">Локально → localStorage • рейтинг HLTV-like</div>
      </div>
      <div style="display:flex;gap:8px;align-items:center">
        <div class="controls">
          <button id="themeToggle">Тема</button>
          <button id="exportBtn">Экспорт</button>
          <button id="importBtn">Импорт</button>
          <button id="ranksBtn">Звания</button>
          <button id="nomsBtn">Номинации</button>
        </div>
      </div>
    </header>

    <!-- LEFT: форма + список -->
    <aside class="card">
      <div style="display:flex;justify-content:space-between;align-items:center">
        <strong>Создать игрока</strong>
        <div class="small" id="count">0</div>
      </div>

      <div style="margin-top:8px">
        <label>Имя</label>
        <input id="name" type="text" placeholder="Никнейм">
      </div>

      <div style="display:grid;grid-template-columns:1fr 1fr;gap:8px;margin-top:8px">
        <div>
          <label>KILLS</label>
          <input id="kills" type="number" min="0" value="0">
        </div>
        <div>
          <label>ASSISTS</label>
          <input id="assists" type="number" min="0" value="0">
        </div>
        <div>
          <label>DEATHS</label>
          <input id="deaths" type="number" min="0" value="0">
        </div>
        <div>
          <label>ROUNDS</label>
          <input id="rounds" type="number" min="0" value="0">
        </div>

        <!-- New fields -->
        <div>
          <label>TOTAL DAMAGE</label>
          <input id="damage" type="number" min="0" value="0" placeholder="Общий урон (ADR = damage / rounds)">
        </div>
        <div>
          <label>KAST (CT %) </label>
          <input id="kast" type="number" min="0" max="100" value="0" placeholder="в % (0-100)">
        </div>

        <div>
          <label>WINS (MATCH)</label>
          <input id="wins" type="number" min="0" value="0">
        </div>
        <div>
          <label>LOSES (MATCH)</label>
          <input id="loses" type="number" min="0" value="0">
        </div>
      </div>

      <div style="display:flex;gap:8px;margin-top:10px">
        <button id="addBtn">Добавить</button>
        <button id="addZeroBtn">Добавить (с 0)</button>
        <button id="clearForm">Сброс</button>
      </div>

      <hr style="margin:10px 0;border:none;height:8px">

      <div style="display:flex;justify-content:space-between;align-items:center">
        <strong>Поиск / Сорт</strong>
        <div class="small">клики: открыть / дублировать</div>
      </div>

      <div class="search">
        <input id="searchInput" type="text" placeholder="Поиск по имени...">
        <select id="sortSelect" title="Сортировать">
          <option value="created">Сначала новые</option>
          <option value="rating">По рейтингу</option>
          <option value="kills">По киллам</option>
          <option value="wins">По победам</option>
        </select>
      </div>

      <div class="players" id="playersList"></div>

      <div class="leader card" style="margin-top:10px">
        <div class="small">Топ 3 (по рейтингу)</div>
        <div id="topList" style="display:flex;gap:8px"></div>
      </div>

      <div class="card" style="margin-top:10px">
        <div class="small"><strong>Номинации (кто что уничтжал)</strong></div>
        <div id="nominationsList" style="margin-top:8px;display:flex;flex-direction:column;gap:6px"></div>
      </div>
    </aside>

    <!-- CENTER: детали выбранного -->
    <main class="card">
      <div style="display:flex;justify-content:space-between;align-items:center;gap:12px;flex-wrap:wrap">
        <div>
          <div id="selName" style="font-weight:700">Нет выбранного игрока</div>
          <div id="selInfo" class="small">Выберите игрока слева</div>
        </div>
        <div style="display:flex;gap:8px;align-items:center">
          <div id="selRank" class="badge" style="display:none"></div>
          <button id="editName">Изм. ник</button>
          <button id="resetPlayer">Сбросить счётчики</button>
          <button id="deletePlayer" style="color:#ff7b7b">Удалить</button>
        </div>
      </div>

      <div class="stat-grid" id="statGrid">
        <div class="stat">
          <div class="small">KILLS</div><div id="vKills" style="font-weight:700">—</div>
          <div class="ops">
            <button data-op="k+">+1</button><button data-op="k-">-1</button><button id="editKills">Изм.</button>
          </div>
          <div class="formula">K</div>
        </div>
        <div class="stat">
          <div class="small">ASSISTS</div><div id="vAssists" style="font-weight:700">—</div>
          <div class="ops">
            <button data-op="a+">+1</button><button data-op="a-">-1</button><button id="editAssists">Изм.</button>
          </div>
          <div class="formula">A</div>
        </div>
        <div class="stat">
          <div class="small">DEATHS</div><div id="vDeaths" style="font-weight:700">—</div>
          <div class="ops">
            <button data-op="d+">+1</button><button data-op="d-">-1</button><button id="editDeaths">Изм.</button>
          </div>
          <div class="formula">D</div>
        </div>
        <div class="stat">
          <div class="small">ROUNDS</div><div id="vRounds" style="font-weight:700">—</div>
          <div class="ops">
            <button data-op="r+">+1</button><button data-op="r-">-1</button><button id="editRounds">Изм.</button>
          </div>
          <div class="formula">R</div>
        </div>
        <div class="stat">
          <div class="small">TOTAL DAMAGE</div><div id="vDamage" style="font-weight:700">—</div>
          <div class="ops"><button id="editDamage">Изм.</button></div>
          <div class="formula">Damage</div>
        </div>
        <div class="stat">
          <div class="small">KAST (CT %)</div><div id="vKast" style="font-weight:700">—</div>
          <div class="ops"><button id="editKast">Изм.</button></div>
          <div class="formula">KAST (%)</div>
        </div>
      </div>

      <div style="display:flex;gap:10px;margin-top:12px;flex-wrap:wrap">
        <div class="card" style="flex:1;min-width:220px">
          <div class="small">KRP = KILLS / ROUNDS</div>
          <div id="vKRP" style="font-weight:700;margin-top:6px">—</div>
          <div class="formula">KRP = K / R</div>
        </div>
        <div class="card" style="flex:1;min-width:220px">
          <div class="small">DPR = DEATHS / ROUNDS</div>
          <div id="vDPR" style="font-weight:700;margin-top:6px">—</div>
          <div class="formula">DPR = D / R</div>
        </div>
        <div class="card" style="flex:1;min-width:220px">
          <div class="small">ADR = Damage / ROUNDS</div>
          <div id="vADR" style="font-weight:700;margin-top:6px">—</div>
          <div class="formula">ADR = Damage / R</div>
        </div>
        <div class="card" style="flex:1;min-width:220px">
          <div class="small">KAST (frac) = KAST% / 100</div>
          <div id="vKASTfrac" style="font-weight:700;margin-top:6px">—</div>
          <div class="formula">KAST_frac = KAST% / 100</div>
        </div>
        <div class="card" style="flex:1;min-width:220px">
          <div class="small">Impact (approx) = (K + 0.5×A) / R</div>
          <div id="vImpact" style="font-weight:700;margin-top:6px">—</div>
          <div class="formula">Impact ≈ (K + 0.5·A) / R</div>
        </div>
        <div class="card" style="flex:1 1 100%;min-width:220px">
          <div class="small">RATING (HLTV-like)</div>
          <div id="vRATING" style="font-weight:700;margin-top:6px">—</div>
          <div class="small" style="margin-top:6px">Формула использует твои коэффициенты (KRP, DPR, KAST, Impact, ADR). Рейтинг ограничен диапазоном 0.00–2.00.</div>
          <div class="formula">R = KRP·0.405022 − DPR·0.657678 + (KAST%/100)·0.524246 + Impact·0.02 + ADR·0.00410341</div>
        </div>
      </div>

      <div class="hotbar" style="margin-top:12px">
        <div class="small">Hotbar: +1/−1 — быстрые изменения; "Изм." — прямое значение; всё сохраняется автоматически.</div>
        <div style="display:flex;gap:8px;align-items:center">
          <button id="addMatchBtn">Добавить матч</button>
          <div class="muted-pill" id="matchCount">Матчей: 0</div>
        </div>
      </div>

      <div id="historyCard" class="card" style="margin-top:12px;display:none">
        <div style="display:flex;justify-content:space-between;align-items:center">
          <div class="small">История матчей (последние 12)</div>
          <div class="small"><button id="clearHistory">Очистить историю</button></div>
        </div>
        <canvas id="spark" class="spark"></canvas>
        <div id="historyList" style="margin-top:8px;display:flex;flex-direction:column;gap:6px;max-height:160px;overflow:auto"></div>
      </div>

    </main>

    <!-- RIGHT: пояснения по формуле и ранги -->
    <aside class="card">
      <div style="display:flex;justify-content:space-between;align-items:center">
        <strong>Формула и ранги (HLTV-style)</strong>
      </div>

      <div style="margin-top:10px" class="small">
        <div><b>Коэффициенты (как ты дал):</b></div>
        <ul style="margin:6px 0 0 18px">
          <li>KRP weight = 0.405022</li>
          <li>DPR weight = −0.657678</li>
          <li>KAST/100 weight = 0.524246</li>
          <li>Impact weight = 0.02 (per round impact value)</li>
          <li>ADR weight = 0.00410341</li>
        </ul>

        <div style="margin-top:8px"><b>Итог:</b> Rating рассчитывается точной линейной комбинацией показателей (см. блоки слева). Результат обрезается до диапазона 0.00–2.00 и выводится с двумя знаками.</div>

        <div style="margin-top:12px"><b>Рекомендованные пороги рангов (HLTV-like):</b>
          <ul style="margin:6px 0 0 18px">
            <li>&lt; 0.80 — Silver</li>
            <li>0.80 — 0.95 — Gold</li>
            <li>0.95 — 1.10 — Platinum</li>
            <li>1.10 — 1.30 — Emerald</li>
            <li>≥ 1.30 — Global</li>
          </ul>
        </div>
      </div>

      <hr style="margin:10px 0;border:none;height:8px">

      <div style="display:flex;gap:8px;flex-wrap:wrap">
        <button id="exportAll">Экспорт JSON</button>
        <button id="importAll">Импорт JSON</button>
        <button id="clearAll" style="color:#ff7b7b">Очистить всё</button>
      </div>
    </aside>

    <footer>Внедрил HLTV-like рейтинг по твоим коэффициентам + новые поля ADR и KAST. Если хочешь, могу: 1) считать KAST автоматически из матчей; 2) заменить prompt() на модалки; 3) использовать реальную метрику Impact из матчевых данных.</footer>
  </div>

<!-- Ranks/Noms modals -->
<div id="ranksModal" class="modal"><div class="box">
  <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:8px">
    <div><strong>Звания — детальная информация</strong><div class="small">Как получить ранги и кто их имеет</div></div>
    <div><button id="closeRanks">Закрыть</button></div>
  </div>
  <div id="ranksContent"></div>
</div></div>

<div id="nomsModal" class="modal"><div class="box">
  <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:8px">
    <div><strong>Номинации — описания и текущие победители</strong><div class="small">Кто получил награды и по каким критериям</div></div>
    <div><button id="closeNoms">Закрыть</button></div>
  </div>
  <div id="nomsContent"></div>
</div></div>

<script>
/* Storage */
const STORE = 'player_stats_hltv_v1';

let players = [];
let selectedId = null;
let uiState = { theme: (document.body.getAttribute('data-theme')||'dark') };

/* helpers */
const $ = id => document.getElementById(id);
function uid(){ return 'p_' + Math.random().toString(36).slice(2,9); }
function save(){ localStorage.setItem(STORE, JSON.stringify(players)); localStorage.setItem('ui_state', JSON.stringify(uiState)); renderList(); renderSelected(); renderNominations(); }
function load(){ try{ const r = localStorage.getItem(STORE); const u = localStorage.getItem('ui_state'); players = r ? JSON.parse(r) : []; if(u){ uiState = JSON.parse(u); document.body.setAttribute('data-theme', uiState.theme); } }catch(e){ console.error(e); players = []; } }

/* ====== New metrics computations ====== */
function computeKRP(p){ // kills per round
  if(!p.rounds) return { display:'0.00', value:0 };
  const v = p.kills / p.rounds;
  return { display: v.toFixed(3), value: v };
}
function computeDPR(p){ // deaths per round
  if(!p.rounds) return { display:'0.00', value:0 };
  const v = p.deaths / p.rounds;
  return { display: v.toFixed(3), value: v };
}
function computeADR(p){ // average damage per round
  if(!p.rounds) return { display:'0', value:0 };
  const v = (p.damage || 0) / p.rounds;
  return { display: v.toFixed(1), value: v };
}
function computeKAST_frac(p){ // KAST fraction (0..1) — using stored KAST% field
  const k = Number(p.kast) || 0;
  const frac = Math.max(0, Math.min(100, k)) / 100;
  return { display: (frac*100).toFixed(1) + '%', value: frac };
}
function computeImpactApprox(p){ // approximation: (K + 0.5*A)/R
  if(!p.rounds) return { display:'0.000', value:0 };
  const v = (p.kills + 0.5*(p.assists||0)) / p.rounds;
  return { display: v.toFixed(3), value: v };
}

/* HLTV-like rating using given coefficients */
function computeRATING(p){
  const krp = computeKRP(p).value;
  const dpr = computeDPR(p).value;
  const kast_frac = computeKAST_frac(p).value;
  const impact = computeImpactApprox(p).value;
  const adr = computeADR(p).value;

  // coefficients you provided
  const cKRP = 0.405022;
  const cDPR = -0.657678; // negative
  const cKAST = 0.524246; // applied to KAST fraction (0..1)
  const cImpact = 0.02;   // per-round impact (we use approximate impact)
  const cADR = 0.00410341;

  let r = krp * cKRP + dpr * cDPR + kast_frac * cKAST + impact * cImpact + adr * cADR;

  // Clamp to realistic HLTV-like range 0..2 (prevents absurd values like 30)
  r = Math.max(0, Math.min(r, 2.0));
  return { display: r.toFixed(3), value: r,
           components: { krp, dpr, kast_frac, impact, adr } };
}

/* RANKS thresholds aligned with rating */
const RANKS_INFO = [
  { id:'silver', name:'Silver', cls:'rank-silver', min:-Infinity, max:0.79, how:'Рейтинг < 0.80' },
  { id:'gold', name:'Gold', cls:'rank-gold', min:0.80, max:0.94, how:'0.80 ≤ рейтинг < 0.95' },
  { id:'platinum', name:'Platinum', cls:'rank-platinum', min:0.95, max:1.09, how:'0.95 ≤ рейтинг < 1.10' },
  { id:'emerald', name:'Emerald', cls:'rank-emerald', min:1.10, max:1.29, how:'1.10 ≤ рейтинг < 1.30' },
  { id:'global', name:'Global', cls:'rank-global', min:1.30, max:Infinity, how:'Рейтинг ≥ 1.30' }
];

function computeRank(p){
  const r = computeRATING(p).value;
  for(const item of RANKS_INFO){
    if(r >= item.min && r <= item.max) return { id:item.id, name:item.name, cls:item.cls };
  }
  return { id:'silver', name:'Silver', cls:'rank-silver' };
}

/* Nominations (same as before) */
function computeNominations(players){
  const res = {};
  if(!players.length) return res;

  let bestRating = -1, pidBestRating = null;
  let bestKD = -1, pidKD = null;
  let bestAVG = -1, pidAVG = null;
  let bestSingle = -1, pidSingle = null;
  let bestWinrate = -1, pidWinrate = null;
  let bestImpact = -Infinity, pidImpact = null;

  players.forEach(p=>{
    const r = computeRATING(p).value;
    if(r > bestRating){ bestRating = r; pidBestRating = p.id; }
    const kd = (p.deaths===0 ? (p.kills>0 ? p.kills : 0) : p.kills / p.deaths);
    if(kd > bestKD){ bestKD = kd; pidKD = p.id; }
    const avg = computeKRP(p).value;
    if(avg > bestAVG){ bestAVG = avg; pidAVG = p.id; }

    (p.matches||[]).forEach(m=>{
      if(m.k > bestSingle){ bestSingle = m.k; pidSingle = p.id; }
    });

    const totalMatches = (p.wins||0) + (p.loses||0);
    if(totalMatches >= 3){
      const wr = computeWINRATE(p).value;
      if(wr > bestWinrate){ bestWinrate = wr; pidWinrate = p.id; }
    }

    const impact = (p.matches||[]).reduce((acc,m)=> acc + (m.k + 0.5*m.a - 0.3*m.d), 0);
    if(impact > bestImpact){ bestImpact = impact; pidImpact = p.id; }
  });

  res['Лучший рейтинг (тек.)'] = pidBestRating;
  res['Лучший KD (тек.)'] = pidKD;
  res['Лучший AVG (убийства/раунд)'] = pidAVG;
  res['Лучший матч (макс убийств в матче)'] = pidSingle;
  res['Лучший винрейт (min 3 матча)'] = pidWinrate;
  res['Highest Impact (MVP-like)'] = pidImpact;
  return res;
}

/* computeWINRATE helper (reused) */
function computeWINRATE(p){
  const totalMatches = (p.wins || 0) + (p.loses || 0);
  if(totalMatches === 0) return { display: '0.0%', value: 0 };
  const value = p.wins / totalMatches;
  return { display: (value*100).toFixed(1) + '%', value };
}

/* Rendering */
const playersList = $('playersList');
const countEl = $('count');

function renderList(){
  playersList.innerHTML = '';
  const q = $('searchInput').value.trim().toLowerCase();
  const sort = $('sortSelect').value;
  let filtered = players.filter(p => !q || p.name.toLowerCase().includes(q));
  if(sort === 'rating') filtered.sort((a,b)=> computeRATING(b).value - computeRATING(a).value);
  else if(sort === 'kills') filtered.sort((a,b)=> b.kills - a.kills);
  else if(sort === 'wins') filtered.sort((a,b)=> b.wins - a.wins);
  else filtered.sort((a,b)=> b.createdAt - a.createdAt);

  countEl.textContent = players.length;
  filtered.forEach(p=>{
    const rank = computeRank(p);
    const div = document.createElement('div');
    div.className = 'player-row' + (p.id === selectedId ? ' selected' : '');
    div.innerHTML = `
      <div style="min-width:0">
        <div style="display:flex;gap:8px;align-items:center">
          <div style="font-weight:700;white-space:nowrap;overflow:hidden;text-overflow:ellipsis">${escapeHtml(p.name)}</div>
          <div class="badge ${rank.cls}" title="Ранг: ${rank.name}">${rank.name}</div>
        </div>
        <div class="small">K:${p.kills} A:${p.assists} D:${p.deaths} R:${p.rounds}</div>
        <div style="margin-top:6px"><small class="small">${p.matches && p.matches.length ? p.matches.length + ' матч(ов) • ' : ''}Создан: ${new Date(p.createdAt).toLocaleDateString()}</small></div>
      </div>
      <div style="display:flex;align-items:center;gap:8px">
        <div class="small" title="Рейтинг">${computeRATING(p).display}</div>
        <div style="display:flex;flex-direction:column;gap:6px">
          <button data-id="${p.id}" data-act="open">Открыть</button>
          <button data-id="${p.id}" data-act="dup">Дубл</button>
        </div>
      </div>
    `;
    playersList.appendChild(div);
  });

  renderTop3();
  renderNominations();
}

function renderTop3(){
  const top = [...players].sort((a,b)=> computeRATING(b).value - computeRATING(a).value).slice(0,3);
  const topList = $('topList'); topList.innerHTML = '';
  top.forEach((p,i)=>{
    const el = document.createElement('div'); el.className='card'; el.style.padding='8px'; el.style.flex='1';
    const rank = computeRank(p);
    el.innerHTML = `<div style="font-weight:700">#${i+1} ${escapeHtml(p.name)} <span class="badge ${rank.cls}" style="margin-left:8px">${rank.name}</span></div><div class="small">R:${computeRATING(p).display} • K:${p.kills} W:${p.wins}</div>`;
    topList.appendChild(el);
  });
}

function renderNominations(){
  const list = $('nominationsList'); list.innerHTML = '';
  const nom = computeNominations(players);
  for(const title in nom){
    const pid = nom[title];
    const el = document.createElement('div'); el.style.display='flex'; el.style.justifyContent='space-between'; el.style.alignItems='center'; el.style.padding='6px'; el.style.borderRadius='6px'; el.style.background='rgba(255,255,255,0.01)';
    el.innerHTML = `<div class="small">${escapeHtml(title)}</div><div class="small">${pid ? escapeHtml((players.find(p=>p.id===pid)||{name:'?'}).name) : '—'}</div>`;
    list.appendChild(el);
  }
}

/* Selection and render selected */
function selectPlayer(id){ selectedId = id; renderList(); renderSelected(); }
function find(id){ return players.find(x=>x.id===id); }

function renderSelected(){
  const nameEl = $('selName'), infoEl = $('selInfo');
  if(!selectedId){ nameEl.textContent = 'Нет выбранного игрока'; infoEl.textContent = 'Выбери слева'; updateStatFieldsEmpty(); return; }
  const p = find(selectedId);
  if(!p){ selectedId = null; renderSelected(); return; }

  nameEl.textContent = p.name;
  infoEl.textContent = 'Создан: ' + new Date(p.createdAt).toLocaleString();

  const rank = computeRank(p);
  const selRank = $('selRank'); selRank.style.display='inline-block'; selRank.className = 'badge ' + rank.cls; selRank.textContent = rank.name;

  $('vKills').textContent = p.kills;
  $('vAssists').textContent = p.assists;
  $('vDeaths').textContent = p.deaths;
  $('vRounds').textContent = p.rounds;
  $('vDamage').textContent = p.damage || 0;
  $('vKast').textContent = (p.kast||0) + '%';

  $('vKRP').textContent = computeKRP(p).display;
  $('vDPR').textContent = computeDPR(p).display;
  $('vADR').textContent = computeADR(p).display;
  $('vKASTfrac').textContent = computeKAST_frac(p).display;
  $('vImpact').textContent = computeImpactApprox(p).display;
  $('vRATING').textContent = computeRATING(p).display;

  // history
  const matches = p.matches || [];
  $('matchCount').textContent = 'Матчей: ' + matches.length;
  if(matches.length){
    $('historyCard').style.display = 'block';
    renderHistory(p);
  } else {
    $('historyCard').style.display = 'none';
  }
}
function updateStatFieldsEmpty(){ ['vKills','vAssists','vDeaths','vRounds','vDamage','vKast','vKRP','vDPR','vADR','vKASTfrac','vImpact','vRATING'].forEach(id=>$(id).textContent='—'); $('selRank').style.display='none'; }

/* Create / edit players */
$('addBtn').onclick = ()=>{
  const name = $('name').value.trim();
  if(!name) return alert('Введите имя');
  const p = {
    id: uid(),
    name,
    kills: Math.max(0, Number($('kills').value) || 0),
    assists: Math.max(0, Number($('assists').value) || 0),
    deaths: Math.max(0, Number($('deaths').value) || 0),
    rounds: Math.max(0, Number($('rounds').value) || 0),
    damage: Math.max(0, Number($('damage').value) || 0),
    kast: Math.max(0, Math.min(100, Number($('kast').value) || 0)),
    wins: Math.max(0, Number($('wins').value) || 0),
    loses: Math.max(0, Number($('loses').value) || 0),
    matches: [],
    createdAt: Date.now()
  };
  players.unshift(p);
  selectedId = p.id;
  save();
  // reset form
  $('name').value = '';
  $('kills').value = 0; $('assists').value = 0; $('deaths').value = 0; $('rounds').value = 0;
  $('damage').value = 0; $('kast').value = 0; $('wins').value = 0; $('loses').value = 0;
};
$('addZeroBtn').onclick = ()=>{ const name = $('name').value.trim(); if(!name) return alert('Введите имя'); const p = { id:uid(), name, kills:0, assists:0, deaths:0, rounds:0, damage:0, kast:0, wins:0, loses:0, matches:[], createdAt:Date.now() }; players.unshift(p); selectedId=p.id; save(); $('name').value=''; };

/* list delegation */
playersList.addEventListener('click', e=>{
  const btn = e.target.closest('button'); if(!btn) return;
  const id = btn.dataset.id; const act = btn.dataset.act;
  if(act === 'open') selectPlayer(id);
  if(act === 'dup'){ const p = find(id); if(!p) return; const copy = Object.assign({}, p, { id: uid(), name: p.name + '_copy', createdAt: Date.now() }); players.unshift(copy); save(); }
});

/* + / - ops */
document.querySelectorAll('[data-op]').forEach(b=> b.addEventListener('click', ()=> applyOp(b.getAttribute('data-op')) ) );

function applyOp(op){
  if(!selectedId){ alert('Выбери игрока'); return; }
  const p = find(selectedId); if(!p) return;
  switch(op){
    case 'k+': p.kills++; break;
    case 'k-': p.kills = Math.max(0,p.kills-1); break;
    case 'a+': p.assists++; break;
    case 'a-': p.assists = Math.max(0,p.assists-1); break;
    case 'd+': p.deaths++; break;
    case 'd-': p.deaths = Math.max(0,p.deaths-1); break;
    case 'r+': p.rounds++; break;
    case 'r-': p.rounds = Math.max(0,p.rounds-1); break;
  }
  save();
}

/* direct edit prompts */
['editKills','editAssists','editDeaths','editRounds','editDamage','editKast','editWins','editLoses'].forEach(id=>{
  const el = $(id);
  if(!el) return;
});

/* edit buttons for damage & kast */
$('editKills') && $('editKills').addEventListener('click', ()=>{ if(!selectedId) return alert('Выбери игрока'); const p=find(selectedId); const v=prompt('KILLS', p.kills); if(v!==null){ p.kills = Math.max(0,parseInt(v)||0); save(); }});
$('editAssists') && $('editAssists').addEventListener('click', ()=>{ if(!selectedId) return alert('Выбери игрока'); const p=find(selectedId); const v=prompt('ASSISTS', p.assists); if(v!==null){ p.assists = Math.max(0,parseInt(v)||0); save(); }});
$('editDeaths') && $('editDeaths').addEventListener('click', ()=>{ if(!selectedId) return alert('Выбери игрока'); const p=find(selectedId); const v=prompt('DEATHS', p.deaths); if(v!==null){ p.deaths = Math.max(0,parseInt(v)||0); save(); }});
$('editRounds') && $('editRounds').addEventListener('click', ()=>{ if(!selectedId) return alert('Выбери игрока'); const p=find(selectedId); const v=prompt('ROUNDS', p.rounds); if(v!==null){ p.rounds = Math.max(0,parseInt(v)||0); save(); }});
$('editDamage') && $('editDamage').addEventListener('click', ()=>{ if(!selectedId) return alert('Выбери игрока'); const p=find(selectedId); const v=prompt('TOTAL DAMAGE', p.damage||0); if(v!==null){ p.damage = Math.max(0,parseInt(v)||0); save(); }});
$('editKast') && $('editKast').addEventListener('click', ()=>{ if(!selectedId) return alert('Выбери игрока'); const p=find(selectedId); const v=prompt('KAST (CT %) 0-100', p.kast||0); if(v!==null){ p.kast = Math.max(0,Math.min(100,parseFloat(v)||0)); save(); }});

/* rename */
$('editName').onclick = ()=>{
  if(!selectedId) return alert('Выбери игрока');
  const p = find(selectedId); if(!p) return;
  const newName = prompt('Новый никнейм', p.name);
  if(newName === null) return;
  const name = newName.trim();
  if(!name) return alert('Имя не может быть пустым');
  p.name = name;
  save();
};

/* delete/reset */
$('deletePlayer').onclick = ()=>{
  if(!selectedId) return alert('Нет выбранного');
  if(!confirm('Удалить игрока?')) return;
  players = players.filter(x=>x.id !== selectedId);
  selectedId = players.length ? players[0].id : null;
  save();
};
$('resetPlayer').onclick = ()=>{
  if(!selectedId) return alert('Нет выбранного');
  if(!confirm('Сбросить все счётчики у игрока?')) return;
  const p = find(selectedId); if(!p) return;
  p.kills = p.assists = p.deaths = p.rounds = p.damage = p.wins = p.loses = 0;
  p.kast = 0;
  p.matches = [];
  save();
};

/* export/import/clear */
$('exportBtn').onclick = ()=>{
  const data = { players };
  const blob = new Blob([JSON.stringify(data,null,2)], {type:'application/json'});
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a'); a.href = url; a.download = 'players_hltv_export.json'; document.body.appendChild(a); a.click(); a.remove(); URL.revokeObjectURL(url);
};
$('importBtn').onclick = ()=> $('importAll').click();
$('exportAll').onclick = $('exportBtn').onclick;
$('importAll').onclick = ()=>{
  const inp = document.createElement('input'); inp.type='file'; inp.accept='application/json';
  inp.onchange = async ()=>{ const f = inp.files[0]; if(!f) return; try{ const txt = await f.text(); const data = JSON.parse(txt); if(Array.isArray(data.players)) players = data.players; selectedId = players.length ? players[0].id : null; save(); alert('Импорт завершён'); }catch(e){ alert('Ошибка импорта'); console.error(e); } };
  inp.click();
};
$('clearAll').onclick = ()=>{
  if(!confirm('Уничтожить все данные (локально)?')) return;
  players = []; selectedId = null; localStorage.removeItem(STORE); save();
};

/* theme */
$('themeToggle').onclick = ()=>{ const cur = document.body.getAttribute('data-theme') || 'dark'; const next = cur === 'dark' ? 'light' : 'dark'; document.body.setAttribute('data-theme', next); uiState.theme = next; save(); };

/* add match (keeps prompts for now; also collects damage and optionally KAST% manual) */
$('addMatchBtn').onclick = ()=>{
  if(!selectedId) return alert('Выбери игрока');
  const k = parseInt(prompt('KILLS в матче', '0')) || 0;
  const a = parseInt(prompt('ASSISTS в матче', '0')) || 0;
  const d = parseInt(prompt('DEATHS в матче', '0')) || 0;
  const r = parseInt(prompt('ROUNDS в матче', '0')) || 0;
  const dmg = parseInt(prompt('DAMAGE в матче', '0')) || 0;
  const win = confirm('Победа в матче? (OK = да, Отмена = нет)');
  const p = find(selectedId);
  if(!p) return;
  p.matches = p.matches || [];
  p.matches.push({ k,a,d,r,dmg,win: !!win, timestamp: Date.now() });
  // aggregate into totals: kills, assists, deaths, rounds, damage, wins/loses
  p.kills += k; p.assists += a; p.deaths += d; p.rounds += r; p.damage = (p.damage || 0) + dmg; if(win) p.wins++; else p.loses++;
  save();
};

$('clearHistory').onclick = ()=>{ if(!selectedId) return alert('Выбери игрока'); if(!confirm('Очистить историю матчей?')) return; const p=find(selectedId); if(!p) return; p.matches=[]; save(); };

function renderHistory(p){
  const list = $('historyList'); list.innerHTML='';
  const arr = (p.matches||[]).slice(-12).reverse();
  arr.forEach(m=>{
    const el = document.createElement('div'); el.className='small'; el.style.display='flex'; el.style.justifyContent='space-between'; el.style.alignItems='center'; el.style.padding='6px'; el.style.borderRadius='6px'; el.style.background='rgba(255,255,255,0.01)';
    el.innerHTML = `<div>K:${m.k} A:${m.a} D:${m.d} R:${m.r} DMG:${m.dmg||0}</div><div>${m.win? 'W':'L'} • ${new Date(m.timestamp).toLocaleString()}</div>`;
    list.appendChild(el);
  });
  drawSpark(p.matches||[]);
}

function drawSpark(matches){
  const canvas = $('spark'); if(!canvas) return;
  const ctx = canvas.getContext('2d');
  const data = (matches||[]).slice(-24).map(m=>m.k);
  const w = canvas.clientWidth; const h = canvas.clientHeight;
  canvas.width = Math.round(w*devicePixelRatio); canvas.height = Math.round(h*devicePixelRatio);
  ctx.scale(devicePixelRatio, devicePixelRatio);
  ctx.clearRect(0,0,w,h);
  if(!data.length) return;
  const max = Math.max(...data); const min = Math.min(...data);
  const span = Math.max(1, max - min);
  ctx.lineWidth = 2; ctx.strokeStyle = getComputedStyle(document.body).getPropertyValue('--accent') || '#6ee7b7';
  ctx.beginPath();
  data.forEach((v,i)=>{
    const x = (i/(data.length-1 || 1))*(w-8)+4;
    const y = h - ((v - min) / span) * (h-8) - 4;
    if(i===0) ctx.moveTo(x,y); else ctx.lineTo(x,y);
  });
  ctx.stroke();
}

/* Ranks & Nominations modals */
function openRanksModal(){
  const root = $('ranksContent'); root.innerHTML = '';
  RANKS_INFO.forEach(r=>{
    const playersWithRank = players.filter(p=> computeRank(p).id === r.id);
    const div = document.createElement('div');
    div.style.padding = '8px'; div.style.borderBottom = '1px solid rgba(255,255,255,0.03)';
    div.innerHTML = `
      <div style="display:flex;justify-content:space-between;align-items:center">
        <div style="font-weight:700">${r.name} <span class="badge ${r.cls}" style="margin-left:8px">${r.name}</span></div>
        <div class="small">${r.how}</div>
      </div>
      <div class="small" style="margin-top:6px"><b>Игроки:</b> ${playersWithRank.length ? playersWithRank.map(p=>escapeHtml(p.name)).join(', ') : '—'}</div>
    `;
    root.appendChild(div);
  });
  $('ranksModal').style.display = 'flex';
}
function closeRanksModal(){ $('ranksModal').style.display = 'none'; }
function openNomsModal(){
  const root = $('nomsContent'); root.innerHTML = '';
  const defs = {
    'Лучший рейтинг (тек.)': 'Игрок с наивысшим текущим рейтингом (HLTV-like).',
    'Лучший KD (тек.)': 'Наибольшее соотношение K/D.',
    'Лучший AVG (убийства/раунд)': 'Максимум K / R.',
    'Лучший матч (макс убийств в матче)': 'Наибольшее убийств в одной записи матча.',
    'Лучший винрейт (min 3 матча)': 'Лучшая доля побед при ≥3 матчах.',
    'Highest Impact (MVP-like)': 'Суммарный показатель (k + 0.5·a − 0.3·d) по матчам.'
  };
  const winners = computeNominations(players);
  for(const key in defs){
    const pid = winners[key];
    const winName = pid ? (players.find(p=>p.id===pid)||{name:'?'}).name : '—';
    const el = document.createElement('div'); el.style.padding='8px'; el.style.borderBottom='1px solid rgba(255,255,255,0.03)';
    el.innerHTML = `<div style="display:flex;justify-content:space-between"><div style="font-weight:700">${escapeHtml(key)}</div><div class="small">${escapeHtml(winName)}</div></div><div class="small" style="margin-top:6px">${escapeHtml(defs[key])}</div>`;
    root.appendChild(el);
  }
  $('nomsModal').style.display = 'flex';
}
function closeNomsModal(){ $('nomsModal').style.display = 'none'; }

$('ranksBtn').onclick = openRanksModal;
$('nomsBtn').onclick = openNomsModal;
$('closeRanks').onclick = closeRanksModal;
$('closeNoms').onclick = closeNomsModal;

/* small util */
function escapeHtml(s){ return String(s).replace(/[&<>"]+/g, m => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;'}[m]||m)); }

/* search/sort events */
$('searchInput').oninput = renderList; $('sortSelect').onchange = renderList;

/* init */
load();
if(players.length && !selectedId) selectedId = players[0].id;
renderList();
renderSelected();
window.addEventListener('resize', ()=>{ if(selectedId){ const p=find(selectedId); if(p && p.matches && p.matches.length) drawSpark(p.matches); } });

</script>

<!-- admin panel (kept) -->
<script>
(function(){
  const ADMIN_KEY = 'is_admin_v3';
  const PASSWORD = '5ugaradmin';
  function isAdmin(){ return localStorage.getItem(ADMIN_KEY) === '1'; }
  function setAdmin(on){ localStorage.setItem(ADMIN_KEY, on ? '1' : '0'); updateAdminUI(); }
  function createAdminPanel(){
    const header = document.querySelector('header'); if(!header) return;
    const wrapper = document.createElement('div'); wrapper.id='adminPanelWrapper'; wrapper.style.display='flex'; wrapper.style.alignItems='center'; wrapper.style.gap='8px'; wrapper.style.marginLeft='12px';
    wrapper.innerHTML = `<div id="adminControls" style="display:flex;gap:8px;align-items:center"><div id="adminBadge" style="font-weight:700;display:none;color:#ffd27f">ADMIN</div><button id="adminLoginBtn">Войти как админ</button><button id="adminLogoutBtn" style="display:none">Выйти</button></div>`;
    const target = header.querySelector('.controls') || header; target.appendChild(wrapper);
    document.getElementById('adminLoginBtn').addEventListener('click', ()=>{ const pw = prompt('Введите пароль администратора'); if(pw===null) return; if(pw===PASSWORD){ setAdmin(true); alert('Админ включён'); } else alert('Неверный пароль'); });
    document.getElementById('adminLogoutBtn').addEventListener('click', ()=>{ setAdmin(false); alert('Админ выключен'); });
  }
  function updateAdminUI(){ const admin = isAdmin(); const badge = document.getElementById('adminBadge'); const loginBtn = document.getElementById('adminLoginBtn'); const logoutBtn = document.getElementById('adminLogoutBtn'); if(badge) badge.style.display = admin ? 'inline-block' : 'none'; if(loginBtn) loginBtn.style.display = admin ? 'none' : 'inline-block'; if(logoutBtn) logoutBtn.style.display = admin ? 'inline-block' : 'none'; const protectedIds = ['deletePlayer','resetPlayer','addMatchBtn','clearHistory','clearAll','exportAll']; protectedIds.forEach(id=>{ const el=document.getElementById(id); if(el) el.disabled = !admin; }); document.querySelectorAll('[data-op]').forEach(b=> b.disabled = !admin); ['editKills','editAssists','editDeaths','editRounds','editDamage','editKast','editName'].forEach(id=>{ const el=document.getElementById(id); if(el) el.disabled = !admin; }); }
  document.addEventListener('click', function(e){ const btn = e.target.closest('button'); if(!btn) return; if(btn.disabled){ e.stopImmediatePropagation(); e.preventDefault(); if(!isAdmin()){ console.warn('Действие заблокировано — требуется админ статус'); } } }, true);
  createAdminPanel(); updateAdminUI(); window.__setAdmin = setAdmin;
})();
</script>

</body>
</html>
