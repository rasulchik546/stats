<!doctype html>
<html lang="ru">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Статистический трекер — K/A/D/W/L/ROUNDS — Enhanced + Ranks</title>
<style>
  :root{
    --bg:#0b0b0b; --panel:#0f1113; --text:#e9eef8; --muted:#9aa3b2; --accent:#6ee7b7; --glass: rgba(255,255,255,0.03);
    --card-shadow: 0 6px 18px rgba(0,0,0,0.45);
    --radius:12px;
  }
  [data-theme="light"]{ --bg:#f6f8fa; --panel:#ffffff; --text:#0b1220; --muted:#556270; --accent:#0f766e; --glass: rgba(10,10,10,0.03); }
  *{box-sizing:border-box;font-family:Inter,ui-sans-serif,system-ui,-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,"Helvetica Neue",Arial}
  html,body{height:100%;margin:0;background:linear-gradient(180deg,var(--bg),#07080a);color:var(--text);-webkit-font-smoothing:antialiased}
  .wrap{max-width:1200px;margin:18px auto;padding:16px;display:grid;grid-template-columns:320px 1fr 320px;gap:14px}
  header{grid-column:1/-1;display:flex;justify-content:space-between;align-items:center;margin-bottom:6px}
  h1{font-size:18px;margin:0;color:var(--accent)}
  .card{background:linear-gradient(180deg,var(--panel),rgba(255,255,255,0.01));padding:14px;border-radius:var(--radius);box-shadow:var(--card-shadow);border:1px solid rgba(255,255,255,0.03)}
  label{font-size:13px;color:var(--muted);display:block;margin-bottom:6px}
  input[type="text"],input[type="number"],select{width:100%;padding:10px;border-radius:10px;border:1px solid rgba(255,255,255,0.04);background:transparent;color:var(--text);font-size:14px}
  .players{display:flex;flex-direction:column;gap:8px;max-height:64vh;overflow:auto;margin-top:10px}
  .player-row{display:flex;justify-content:space-between;align-items:center;padding:10px;border-radius:10px}
  .player-row:hover{background:var(--glass)}
  .player-row.selected{outline:2px solid rgba(255,255,255,0.04);background:linear-gradient(90deg, rgba(255,255,255,0.02), transparent)}
  .stat-grid{display:grid;grid-template-columns:repeat(3,1fr);gap:10px;margin-top:10px}
  .stat{background:rgba(255,255,255,0.01);padding:12px;border-radius:10px;text-align:center}
  .ops{display:flex;gap:6px;justify-content:center;margin-top:8px}
  .hotbar{display:flex;justify-content:space-between;align-items:center;padding:10px;margin-top:10px;border-radius:8px;background:rgba(255,255,255,0.01)}
  button{padding:8px 10px;border-radius:8px;border:1px solid rgba(255,255,255,0.04);background:transparent;color:var(--text);cursor:pointer}
  .small{font-size:13px;color:var(--muted)}
  footer{grid-column:1/-1;text-align:center;color:var(--muted);margin-top:10px;font-size:13px}
  .controls{display:flex;gap:8px;align-items:center}
  .search{display:flex;gap:8px;margin-top:10px}
  .flex{display:flex;gap:8px}
  .leader{display:flex;flex-direction:column;gap:8px;margin-top:10px}
  canvas.spark{width:100%;height:40px;border-radius:6px;display:block}
  .muted-pill{padding:6px 8px;border-radius:999px;background:rgba(255,255,255,0.02);font-size:12px;color:var(--muted)}
  .badge{padding:4px 8px;border-radius:999px;background:rgba(255,255,255,0.03);font-size:12px}
  .rank-silver{background:linear-gradient(90deg,#c0c0c0,#b0b0b0);color:#111}
  .rank-gold{background:linear-gradient(90deg,#ffd27f,#f6c85f);color:#111}
  .rank-platinum{background:linear-gradient(90deg,#cfeaf5,#9ad3e8);color:#111}
  .rank-diamond{background:linear-gradient(90deg,#b7e0ff,#8fcfff);color:#011}
  .rank-emerald{background:linear-gradient(90deg,#7bf0b3,#4edc93);color:#012}
  .rank-global{background:linear-gradient(90deg,#ffd3ff,#ffb7f0);color:#111}

  /* modal */
  .modal { position: fixed; inset:0; display:none; align-items:center; justify-content:center; background:rgba(0,0,0,0.55); z-index:9999; }
  .modal .box { width:min(880px,96%); max-height:80vh; overflow:auto; background:var(--panel); padding:18px; border-radius:12px; border:1px solid rgba(255,255,255,0.03); }
  .modal .row { display:flex; gap:12px; align-items:center; justify-content:space-between; }
  .formula { font-family:monospace; font-size:13px; color:var(--muted); margin-top:6px; }

  @media (max-width:1100px){.wrap{grid-template-columns:1fr 360px;max-width:980px} aside:last-child{order:3} }
  @media (max-width:800px){.wrap{grid-template-columns:1fr;padding:12px} header{flex-direction:column;align-items:flex-start;gap:8px} .players{max-height:36vh} .stat-grid{grid-template-columns:repeat(2,1fr)} }
</style>
</head>
<body data-theme="dark">
  <div class="wrap">
    <header>
      <div>
        <h1>Трекер игроков — K/A/D / MATCH W/L / ROUNDS</h1>
        <div class="small">Локально → localStorage • Ранги и номинации</div>
      </div>
      <div style="display:flex;gap:8px;align-items:center">
        <div class="controls">
          <button id="themeToggle">Тема</button>
          <button id="exportBtn">Экспорт</button>
          <button id="importBtn">Импорт</button>
          <!-- Новые кнопки: Звания и Номинации -->
          <button id="ranksBtn">Звания</button>
          <button id="nomsBtn">Номинации</button>
        </div>
      </div>
    </header>

    <!-- LEFT: форма + список -->
    <aside class="card">
      <div style="display:flex;justify-content:space-between;align-items:center">
        <strong>Создать игрока</strong>
        <div class="small" id="count">0</div>
      </div>

      <div style="margin-top:8px">
        <label>Имя</label>
        <input id="name" type="text" placeholder="Никнейм">
      </div>

      <div style="display:grid;grid-template-columns:1fr 1fr;gap:8px;margin-top:8px">
        <div>
          <label>KILLS</label>
          <input id="kills" type="number" min="0" value="0">
        </div>
        <div>
          <label>ASSISTS</label>
          <input id="assists" type="number" min="0" value="0">
        </div>
        <div>
          <label>DEATHS</label>
          <input id="deaths" type="number" min="0" value="0">
        </div>
        <div>
          <label>ROUNDS (кол-во раундов)</label>
          <input id="rounds" type="number" min="0" value="0">
        </div>
        <div>
          <label>WINS (MATCH WINS — победы в матчах)</label>
          <input id="wins" type="number" min="0" value="0">
        </div>
        <div>
          <label>LOSES (MATCH LOSES — поражения в матчах)</label>
          <input id="loses" type="number" min="0" value="0">
        </div>
      </div>

      <div style="display:flex;gap:8px;margin-top:10px">
        <button id="addBtn">Добавить</button>
        <button id="addZeroBtn">Добавить (с 0)</button>
        <button id="clearForm">Сброс</button>
      </div>

      <hr style="margin:10px 0;border:none;height:8px">

      <div style="display:flex;justify-content:space-between;align-items:center">
        <strong>Поиск / Сорт</strong>
        <div class="small">клики: открыть / дублировать</div>
      </div>

      <div class="search">
        <input id="searchInput" type="text" placeholder="Поиск по имени...">
        <select id="sortSelect" title="Сортировать">
          <option value="created">Сначала новые</option>
          <option value="rating">По рейтингу</option>
          <option value="kills">По киллам</option>
          <option value="wins">По победам</option>
        </select>
      </div>

      <div class="players" id="playersList"></div>

      <div class="leader card" style="margin-top:10px">
        <div class="small">Топ 3 (по рейтингу)</div>
        <div id="topList" style="display:flex;gap:8px"></div>
      </div>

      <div class="card" style="margin-top:10px">
        <div class="small"><strong>Номинации (кто что уничтжал)</strong></div>
        <div id="nominationsList" style="margin-top:8px;display:flex;flex-direction:column;gap:6px"></div>
      </div>
    </aside>

    <!-- CENTER: детали выбранного -->
    <main class="card">
      <div style="display:flex;justify-content:space-between;align-items:center;gap:12px;flex-wrap:wrap">
        <div>
          <div id="selName" style="font-weight:700">Нет выбранного игрока</div>
          <div id="selInfo" class="small">Выберите игрока слева</div>
        </div>
        <div style="display:flex;gap:8px;align-items:center">
          <div id="selRank" class="badge" style="display:none"></div>
          <!-- Кнопка переименования игрока -->
          <button id="editName">Изм. ник</button>
          <button id="resetPlayer">Сбросить счётчики</button>
          <button id="deletePlayer" style="color:#ff7b7b">Удалить</button>
        </div>
      </div>

      <div class="stat-grid" id="statGrid">
        <div class="stat">
          <div class="small">KILLS</div><div id="vKills" style="font-weight:700">—</div>
          <div class="ops">
            <button data-op="k+">+1</button><button data-op="k-">-1</button><button id="editKills">Изм.</button>
          </div>
          <div class="formula">формула: —</div>
        </div>
        <div class="stat">
          <div class="small">ASSISTS</div><div id="vAssists" style="font-weight:700">—</div>
          <div class="ops">
            <button data-op="a+">+1</button><button data-op="a-">-1</button><button id="editAssists">Изм.</button>
          </div>
          <div class="formula">формула: —</div>
        </div>
        <div class="stat">
          <div class="small">DEATHS</div><div id="vDeaths" style="font-weight:700">—</div>
          <div class="ops">
            <button data-op="d+">+1</button><button data-op="d-">-1</button><button id="editDeaths">Изм.</button>
          </div>
          <div class="formula">формула: —</div>
        </div>
        <div class="stat">
          <div class="small">ROUNDS</div><div id="vRounds" style="font-weight:700">—</div>
          <div class="ops">
            <button data-op="r+">+1</button><button data-op="r-">-1</button><button id="editRounds">Изм.</button>
          </div>
          <div class="formula">формула: —</div>
        </div>
        <div class="stat">
          <div class="small">WINS (MATCH)</div><div id="vWins" style="font-weight:700">—</div>
          <div class="ops">
            <button data-op="w+">+1</button><button data-op="w-">-1</button><button id="editWins">Изм.</button>
          </div>
          <div class="formula">формула: —</div>
        </div>
        <div class="stat">
          <div class="small">LOSES (MATCH)</div><div id="vLoses" style="font-weight:700">—</div>
          <div class="ops">
            <button data-op="l+">+1</button><button data-op="l-">-1</button><button id="editLoses">Изм.</button>
          </div>
          <div class="formula">формула: —</div>
        </div>
      </div>

      <div style="display:flex;gap:10px;margin-top:12px;flex-wrap:wrap">
        <div class="card" style="flex:1;min-width:220px">
          <div class="small">KD = KILLS / DEATHS</div>
          <div id="vKD" style="font-weight:700;margin-top:6px">—</div>
          <div class="small" style="margin-top:6px">Если DEATHS = 0 → отображаем "Perfect" и в расчёте используем DEATHS_FOR_CALC = 1.</div>
          <div class="formula">KD = K / D</div>
        </div>
        <div class="card" style="flex:1;min-width:220px">
          <div class="small">KAD = (KILLS + ASSISTS) / DEATHS</div>
          <div id="vKAD" style="font-weight:700;margin-top:6px">—</div>
          <div class="formula">KAD = (K + A) / D</div>
        </div>
        <div class="card" style="flex:1;min-width:220px">
          <div class="small">AVG = KILLS / ROUNDS (убийства за раунд)</div>
          <div id="vAVG" style="font-weight:700;margin-top:6px">—</div>
          <div class="formula">AVG = K / R</div>
        </div>
        <div class="card" style="flex:1;min-width:220px">
          <div class="small">SVR = (ROUNDS − DEATHS) / ROUNDS × 100% (выживаемость)</div>
          <div id="vSVR" style="font-weight:700;margin-top:6px">—</div>
          <div class="formula">SVR = (R − D) / R × 100%</div>
        </div>
        <div class="card" style="flex:1;min-width:220px">
          <div class="small">WINRATE = WINS / (WINS + LOSES) × 100% (матч-вдох)</div>
          <div id="vWINRATE" style="font-weight:700;margin-top:6px">—</div>
          <div class="formula">WINRATE = W / (W + L) × 100%</div>
        </div>
        <div class="card" style="flex:1 1 100%;min-width:220px">
          <div class="small">RATING — комбинированный индекс (0–100)</div>
          <div id="vRATING" style="font-weight:700;margin-top:6px">—</div>
          <div class="small" style="margin-top:6px">Нормализация: KD cap 5, KAD cap 7, AVG cap 2, SVR 0–100, WINRATE 0–100. Рейтинг = среднее нормализованных метрик × 100.</div>
          <div class="formula">RATING = mean( norm(KD), norm(KAD), norm(AVG), norm(SVR), norm(WINRATE) ) × 100</div>
        </div>
      </div>

      <div class="hotbar" style="margin-top:12px">
        <div class="small">Hotbar: +1/−1 — быстрые изменения; "Изм." — прямое значение; всё сохраняется автоматически.</div>
        <div style="display:flex;gap:8px;align-items:center">
          <button id="addMatchBtn">Добавить матч</button>
          <div class="muted-pill" id="matchCount">Матчей: 0</div>
        </div>
      </div>

      <div id="historyCard" class="card" style="margin-top:12px;display:none">
        <div style="display:flex;justify-content:space-between;align-items:center">
          <div class="small">История матчей (последние 12)</div>
          <div class="small"><button id="clearHistory">Очистить историю</button></div>
        </div>
        <canvas id="spark" class="spark"></canvas>
        <div id="historyList" style="margin-top:8px;display:flex;flex-direction:column;gap:6px;max-height:160px;overflow:auto"></div>
      </div>

    </main>

    <!-- RIGHT: формулы и пояснения (весов больше нет) -->
    <aside class="card">
      <div style="display:flex;justify-content:space-between;align-items:center">
        <strong>Формулы (HLTV-like)</strong>
      </div>

      <div style="margin-top:10px" class="small">
        Рейтинг теперь считается **без ручных весов** — одинаковый вклад каждой нормализованной метрики.
        <div style="margin-top:8px">
          <div><b>Нормализация:</b></div>
          <ul style="margin:6px 0 0 18px">
            <li>K D<sub>norm</sub> = min(KD, 5) / 5</li>
            <li>K A D<sub>norm</sub> = min(KAD, 7) / 7</li>
            <li>AVG<sub>norm</sub> = min(AVG, 2) / 2</li>
            <li>SVR<sub>norm</sub> = SVR(%) / 100</li>
            <li>WINRATE<sub>norm</sub> = WINRATE (0..1)</li>
          </ul>
        </div>
        <div style="margin-top:8px">
          <div><b>Итоговая формула:</b></div>
          <div class="formula">RATING = ((KD_norm + KAD_norm + AVG_norm + SVR_norm + WIN_norm) / 5) × 100</div>
        </div>
      </div>

      <hr style="margin:10px 0;border:none;height:8px">

      <div style="display:flex;gap:8px;flex-wrap:wrap">
        <button id="exportAll">Экспорт JSON</button>
        <button id="importAll">Импорт JSON</button>
        <button id="clearAll" style="color:#ff7b7b">Очистить всё</button>
      </div>
    </aside>

    <footer>Готово: добавлены режимы переименования, модальные окна для званий и номинаций, рейтинг без весов.</footer>
  </div>

<!-- ==== Modals ==== -->
<div id="ranksModal" class="modal"><div class="box">
  <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:8px">
    <div><strong>Звания — детальная информация</strong><div class="small">Как получить ранги и кто их имеет</div></div>
    <div><button id="closeRanks">Закрыть</button></div>
  </div>
  <div id="ranksContent"></div>
</div></div>

<div id="nomsModal" class="modal"><div class="box">
  <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:8px">
    <div><strong>Номинации — описания и текущие победители</strong><div class="small">Кто получил награды и по каким критериям</div></div>
    <div><button id="closeNoms">Закрыть</button></div>
  </div>
  <div id="nomsContent"></div>
</div></div>

<script>
/* ========== Настройки хранения ========== */
const STORE = 'player_stats_v3';

/* Структура игрока:
{ id, name, kills, assists, deaths, rounds, wins, loses, createdAt, matches: [ {k,a,d,r,win,timestamp} ] }
*/

let players = [];
let selectedId = null;
let uiState = { theme: (document.body.getAttribute('data-theme')||'dark') };

/* ---------- Утилиты ---------- */
const $ = id => document.getElementById(id);
function uid(){ return 'p_' + Math.random().toString(36).slice(2,9); }
function save(){ localStorage.setItem(STORE, JSON.stringify(players)); localStorage.setItem('ui_state', JSON.stringify(uiState)); renderList(); renderSelected(); renderNominations(); }
function load(){ try{ const r = localStorage.getItem(STORE); const u = localStorage.getItem('ui_state'); players = r ? JSON.parse(r) : []; if(u){ uiState = JSON.parse(u); document.body.setAttribute('data-theme', uiState.theme); } }catch(e){ console.error(e); players = []; } }

/* ---------- Формулы (реализация — равный вклад) ---------- */
function computeKD(p){
  const denom = p.deaths === 0 ? 1 : p.deaths;
  const value = denom === 0 ? 0 : p.kills / denom;
  const display = p.deaths === 0 ? 'Perfect' : value.toFixed(2);
  return { display, value };
}
function computeKAD(p){
  const denom = p.deaths === 0 ? 1 : p.deaths;
  const value = denom === 0 ? 0 : (p.kills + p.assists) / denom;
  return { display: value.toFixed(2), value };
}
function computeAVG(p){
  if(!p.rounds) return { display: '0.00', value: 0 };
  const value = p.kills / p.rounds;
  return { display: value.toFixed(2), value };
}
function computeSVR(p){
  if(!p.rounds) return { display: '0.0%', value: 0 };
  const surv = Math.max(0, p.rounds - p.deaths);
  const value = (surv / p.rounds) * 100;
  return { display: value.toFixed(1) + '%', value };
}
function computeWINRATE(p){
  const totalMatches = (p.wins || 0) + (p.loses || 0);
  if(totalMatches === 0) return { display: '0.0%', value: 0 };
  const value = p.wins / totalMatches;
  return { display: (value*100).toFixed(1) + '%', value };
}

/* Нормализаторы */
function normKD(v){ return Math.min(v,5)/5; }
function normKAD(v){ return Math.min(v,7)/7; }
function normAVG(v){ return Math.min(v,2)/2; }
function normSVR(v){ return Math.min(Math.max(v,0),100)/100; }
function normWIN(v){ return Math.min(Math.max(v,0),1); }

/* computeRATING: равный вклад нормализованных метрик -> 0..100 */
function computeRATING(p){
  const kd = computeKD(p).value;
  const kad = computeKAD(p).value;
  const avg = computeAVG(p).value;
  const svr = computeSVR(p).value;
  const win = computeWINRATE(p).value;

  const kd_norm = normKD(kd);
  const kad_norm = normKAD(kad);
  const avg_norm = normAVG(avg);
  const svr_norm = normSVR(svr);
  const win_norm = normWIN(win);

  const mean = (kd_norm + kad_norm + avg_norm + svr_norm + win_norm) / 5;
  const score = mean * 100;
  return { display: score.toFixed(2), value: score };
}

/* ---------- Ранги — пороги чуть легче, смягчены на ~10% ----------- */
/* Рекомендуемые описания (id,name,cls,threshold,how-to) */
const RANKS_INFO = [
  { id:'silver', name:'Silver', cls:'rank-silver', min:0, max:9, how:'Базовый уровень — рейтинг < 10.' },
  { id:'gold', name:'Gold', cls:'rank-gold', min:10, max:24, how:'Игрок с устойчивыми показателями: рейтинг от 10 до 24.' },
  { id:'platinum', name:'Platinum', cls:'rank-platinum', min:25, max:44, how:'Опытный игрок: рейтинг от 25 до 44.' },
  { id:'diamond', name:'Diamond', cls:'rank-diamond', min:45, max:64, how:'Высокий уровень игры: рейтинг от 45 до 64.' },
  { id:'emerald', name:'Emerald', cls:'rank-emerald', min:65, max:79, how:'Отличные показатели: рейтинг от 65 до 79.' },
  { id:'global', name:'Global', cls:'rank-global', min:80, max:100, how:'Топ-уровень: рейтинг ≥ 80.' }
];

function computeRank(p){
  const score = computeRATING(p).value; // 0..100
  for(const r of RANKS_INFO){
    if(score >= r.min && score <= r.max) return { id: r.id, name: r.name, cls: r.cls };
  }
  // fallback
  return { id:'silver', name:'Silver', cls:'rank-silver' };
}

/* ---------- Номинации: расширенные и описанные ---------- */
function computeNominations(players){
  const res = {};
  if(!players.length) return res;

  // Best Player (highest rating)
  let bestRating = -1, pidBestRating = null;
  // Best KD
  let bestKD = -1, pidKD = null;
  // Best AVG
  let bestAVG = -1, pidAVG = null;
  // Highest single-match kills
  let bestSingle = -1, pidSingle = null;
  // Best WINRATE (>=3 matches)
  let bestWinrate = -1, pidWinrate = null;
  // Most MVP-like (highest sum of K+A - D across matches)
  let bestImpact = -Infinity, pidImpact = null;

  players.forEach(p=>{
    const r = computeRATING(p).value;
    if(r > bestRating){ bestRating = r; pidBestRating = p.id; }
    const kd = computeKD(p).value; if(kd > bestKD){ bestKD = kd; pidKD = p.id; }
    const avg = computeAVG(p).value; if(avg > bestAVG){ bestAVG = avg; pidAVG = p.id; }

    (p.matches||[]).forEach(m=>{
      if(m.k > bestSingle){ bestSingle = m.k; pidSingle = p.id; }
    });

    const totalMatches = (p.wins||0) + (p.loses||0);
    if(totalMatches >= 3){
      const wr = computeWINRATE(p).value;
      if(wr > bestWinrate){ bestWinrate = wr; pidWinrate = p.id; }
    }

    // impact metric: sum over matches of (k + a*0.5 - d*0.3)
    const impact = (p.matches||[]).reduce((acc,m)=> acc + (m.k + 0.5*m.a - 0.3*m.d), 0);
    if(impact > bestImpact){ bestImpact = impact; pidImpact = p.id; }
  });

  res['Лучший рейтинг (тек.)'] = pidBestRating;
  res['Лучший KD (тек.)'] = pidKD;
  res['Лучший AVG (убийства/раунд)'] = pidAVG;
  res['Лучший матч (макс убийств в матче)'] = pidSingle;
  res['Лучший винрейт (min 3 матча)'] = pidWinrate;
  res['Highest Impact (MVP-like)'] = pidImpact;
  return res;
}

/* ---------- Рендер списка + топ + номинации ---------- */
const playersList = $('playersList');
const countEl = $('count');

function renderList(){
  playersList.innerHTML = '';
  const q = $('searchInput').value.trim().toLowerCase();
  const sort = $('sortSelect').value;
  let filtered = players.filter(p => !q || p.name.toLowerCase().includes(q));
  if(sort === 'rating') filtered.sort((a,b)=> computeRATING(b).value - computeRATING(a).value);
  else if(sort === 'kills') filtered.sort((a,b)=> b.kills - a.kills);
  else if(sort === 'wins') filtered.sort((a,b)=> b.wins - a.wins);
  else filtered.sort((a,b)=> b.createdAt - a.createdAt);

  countEl.textContent = players.length;
  filtered.forEach(p=>{
    const rank = computeRank(p);
    const div = document.createElement('div');
    div.className = 'player-row' + (p.id === selectedId ? ' selected' : '');
    div.innerHTML = `
      <div style="min-width:0">
        <div style="display:flex;gap:8px;align-items:center">
          <div style="font-weight:700;white-space:nowrap;overflow:hidden;text-overflow:ellipsis">${escapeHtml(p.name)}</div>
          <div class="badge ${rank.cls}" title="Ранг: ${rank.name}">${rank.name}</div>
        </div>
        <div class="small">K:${p.kills} A:${p.assists} D:${p.deaths} R:${p.rounds}</div>
        <div style="margin-top:6px"><small class="small">${p.matches && p.matches.length ? p.matches.length + ' матч(ов) • ' : ''}Создан: ${new Date(p.createdAt).toLocaleDateString()}</small></div>
      </div>
      <div style="display:flex;align-items:center;gap:8px">
        <div class="small" title="Рейтинг">${computeRATING(p).display}</div>
        <div style="display:flex;flex-direction:column;gap:6px">
          <button data-id="${p.id}" data-act="open">Открыть</button>
          <button data-id="${p.id}" data-act="dup">Дубл</button>
        </div>
      </div>
    `;
    playersList.appendChild(div);
  });

  renderTop3();
  renderNominations();
}

function renderTop3(){
  const top = [...players].sort((a,b)=> computeRATING(b).value - computeRATING(a).value).slice(0,3);
  const topList = $('topList'); topList.innerHTML = '';
  top.forEach((p,i)=>{
    const el = document.createElement('div'); el.className='card'; el.style.padding='8px'; el.style.flex='1';
    const rank = computeRank(p);
    el.innerHTML = `<div style="font-weight:700">#${i+1} ${escapeHtml(p.name)} <span class="badge ${rank.cls}" style="margin-left:8px">${rank.name}</span></div><div class="small">R:${computeRATING(p).display} • K:${p.kills} W:${p.wins}</div>`;
    topList.appendChild(el);
  });
}

function renderNominations(){
  const list = $('nominationsList'); list.innerHTML = '';
  const nom = computeNominations(players);
  for(const title in nom){
    const pid = nom[title];
    const el = document.createElement('div'); el.style.display='flex'; el.style.justifyContent='space-between'; el.style.alignItems='center'; el.style.padding='6px'; el.style.borderRadius='6px'; el.style.background='rgba(255,255,255,0.01)';
    el.innerHTML = `<div class="small">${escapeHtml(title)}</div><div class="small">${pid ? escapeHtml((players.find(p=>p.id===pid)||{name:'?'}).name) : '—'}</div>`;
    list.appendChild(el);
  }
}

/* ---------- Выбор и отображение выбранного ---------- */
function selectPlayer(id){ selectedId = id; renderList(); renderSelected(); }
function find(id){ return players.find(x=>x.id===id); }

function renderSelected(){
  const nameEl = $('selName'), infoEl = $('selInfo');
  if(!selectedId){ nameEl.textContent = 'Нет выбранного игрока'; infoEl.textContent = 'Выбери слева'; updateStatFieldsEmpty(); return; }
  const p = find(selectedId);
  if(!p){ selectedId = null; renderSelected(); return; }

  nameEl.textContent = p.name;
  infoEl.textContent = 'Создан: ' + new Date(p.createdAt).toLocaleString();

  const rank = computeRank(p);
  const selRank = $('selRank'); selRank.style.display='inline-block'; selRank.className = 'badge ' + rank.cls; selRank.textContent = rank.name;

  $('vKills').textContent = p.kills;
  $('vAssists').textContent = p.assists;
  $('vDeaths').textContent = p.deaths;
  $('vRounds').textContent = p.rounds;
  $('vWins').textContent = p.wins;
  $('vLoses').textContent = p.loses;

  $('vKD').textContent = computeKD(p).display;
  $('vKAD').textContent = computeKAD(p).display;
  $('vAVG').textContent = computeAVG(p).display;
  $('vSVR').textContent = computeSVR(p).display;
  $('vWINRATE').textContent = computeWINRATE(p).display;
  $('vRATING').textContent = computeRATING(p).display;

  // history
  const matches = p.matches || [];
  $('matchCount').textContent = 'Матчей: ' + matches.length;
  if(matches.length){
    $('historyCard').style.display = 'block';
    renderHistory(p);
  } else {
    $('historyCard').style.display = 'none';
  }
}
function updateStatFieldsEmpty(){ ['vKills','vAssists','vDeaths','vRounds','vWins','vLoses','vKD','vKAD','vAVG','vSVR','vWINRATE','vRATING'].forEach(id=>$(id).textContent='—'); $('selRank').style.display='none'; }

/* ---------- Создание / изменение ---------- */
$('addBtn').onclick = ()=>{
  const name = $('name').value.trim();
  if(!name) return alert('Введите имя');
  const p = {
    id: uid(),
    name,
    kills: Math.max(0, Number($('kills').value) || 0),
    assists: Math.max(0, Number($('assists').value) || 0),
    deaths: Math.max(0, Number($('deaths').value) || 0),
    rounds: Math.max(0, Number($('rounds').value) || 0),
    wins: Math.max(0, Number($('wins').value) || 0),
    loses: Math.max(0, Number($('loses').value) || 0),
    matches: [],
    createdAt: Date.now()
  };
  players.unshift(p);
  selectedId = p.id;
  save();
  // Сброс формы
  $('name').value = '';
  $('kills').value = 0;
  $('assists').value = 0;
  $('deaths').value = 0;
  $('rounds').value = 0;
  $('wins').value = 0;
  $('loses').value = 0;
};
$('addZeroBtn').onclick = ()=>{ const name = $('name').value.trim(); if(!name) return alert('Введите имя'); const p = { id:uid(), name, kills:0, assists:0, deaths:0, rounds:0, wins:0, loses:0, matches:[], createdAt:Date.now() }; players.unshift(p); selectedId=p.id; save(); $('name').value=''; };

/* Делегирование кликов по списку */
playersList.addEventListener('click', e=>{
  const btn = e.target.closest('button'); if(!btn) return;
  const id = btn.dataset.id; const act = btn.dataset.act;
  if(act === 'open') selectPlayer(id);
  if(act === 'dup'){ const p = find(id); if(!p) return; const copy = Object.assign({}, p, { id: uid(), name: p.name + '_copy', createdAt: Date.now() }); players.unshift(copy); save(); }
});

/* ---------- + / - и прямое редактирование ---------- */
document.querySelectorAll('[data-op]').forEach(b=> b.addEventListener('click', ()=> applyOp(b.getAttribute('data-op')) ) );

function applyOp(op){
  if(!selectedId){ alert('Выбери игрока'); return; }
  const p = find(selectedId); if(!p) return;
  switch(op){
    case 'k+': p.kills++; break;
    case 'k-': p.kills = Math.max(0,p.kills-1); break;
    case 'a+': p.assists++; break;
    case 'a-': p.assists = Math.max(0,p.assists-1); break;
    case 'd+': p.deaths++; break;
    case 'd-': p.deaths = Math.max(0,p.deaths-1); break;
    case 'r+': p.rounds++; break;
    case 'r-': p.rounds = Math.max(0,p.rounds-1); break;
    case 'w+': p.wins++; break;
    case 'w-': p.wins = Math.max(0,p.wins-1); break;
    case 'l+': p.loses++; break;
    case 'l-': p.loses = Math.max(0,p.loses-1); break;
  }
  save();
}

/* Прямое редактирование через prompt */
['editKills','editAssists','editDeaths','editRounds','editWins','editLoses'].forEach(id=>{
  const el = $(id); if(!el) return;
  el.onclick = ()=>{
    if(!selectedId){ alert('Выбери игрока'); return; }
    const p = find(selectedId); if(!p) return;
    const map = { editKills:'kills', editAssists:'assists', editDeaths:'deaths', editRounds:'rounds', editWins:'wins', editLoses:'loses' };
    const field = map[id];
    const v = prompt('Новое значение для ' + field.toUpperCase(), p[field]);
    if(v === null) return;
    p[field] = Math.max(0, parseInt(v) || 0);
    save();
  };
});

/* ---------- Переименование игрока (новая фича) ---------- */
$('editName').onclick = ()=>{
  if(!selectedId) return alert('Выбери игрока');
  const p = find(selectedId); if(!p) return;
  const newName = prompt('Новый никнейм', p.name);
  if(newName === null) return;
  const name = newName.trim();
  if(!name) return alert('Имя не может быть пустым');
  p.name = name;
  save();
};

/* ---------- Удаление / сброс ---------- */
$('deletePlayer').onclick = ()=>{
  if(!selectedId) return alert('Нет выбранного');
  if(!confirm('Удалить игрока?')) return;
  players = players.filter(x=>x.id !== selectedId);
  selectedId = players.length ? players[0].id : null;
  save();
};
$('resetPlayer').onclick = ()=>{
  if(!selectedId) return alert('Нет выбранного');
  if(!confirm('Сбросить все счётчики у игрока?')) return;
  const p = find(selectedId); if(!p) return;
  p.kills = p.assists = p.deaths = p.rounds = p.wins = p.loses = 0;
  p.matches = [];
  save();
};

/* ---------- Экспорт / импорт / очистка ---------- */
$('exportBtn').onclick = ()=>{
  const data = { players };
  const blob = new Blob([JSON.stringify(data,null,2)], {type:'application/json'});
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a'); a.href = url; a.download = 'players_export.json'; document.body.appendChild(a); a.click(); a.remove(); URL.revokeObjectURL(url);
};
$('importBtn').onclick = ()=> $('importAll').click();
$('exportAll').onclick = $('exportBtn').onclick;
$('importAll').onclick = ()=>{
  const inp = document.createElement('input'); inp.type='file'; inp.accept='application/json';
  inp.onchange = async ()=>{ const f = inp.files[0]; if(!f) return; try{ const txt = await f.text(); const data = JSON.parse(txt); if(Array.isArray(data.players)) players = data.players; selectedId = players.length ? players[0].id : null; save(); alert('Импорт завершён'); }catch(e){ alert('Ошибка импорта'); console.error(e); } };
  inp.click();
};
$('clearAll').onclick = ()=>{
  if(!confirm('Уничтожить все данные (локально)?')) return;
  players = []; selectedId = null; localStorage.removeItem(STORE); save();
};

/* ---------- Тема ---------- */
$('themeToggle').onclick = ()=>{ const cur = document.body.getAttribute('data-theme') || 'dark'; const next = cur === 'dark' ? 'light' : 'dark'; document.body.setAttribute('data-theme', next); uiState.theme = next; save(); };

/* ---------- Добавление матча (prompt пока) ---------- */
$('addMatchBtn').onclick = ()=>{
  if(!selectedId) return alert('Выбери игрока');
  const k = parseInt(prompt('KILLS в матче', '0')) || 0;
  const a = parseInt(prompt('ASSISTS в матче', '0')) || 0;
  const d = parseInt(prompt('DEATHS в матче', '0')) || 0;
  const r = parseInt(prompt('ROUNDS в матче', '0')) || 0;
  const win = confirm('Победа в матче? (OK = да, Отмена = нет)');
  const p = find(selectedId);
  if(!p) return;
  p.matches = p.matches || [];
  p.matches.push({ k,a,d,r,win: !!win, timestamp: Date.now() });
  p.kills += k; p.assists += a; p.deaths += d; p.rounds += r; if(win) p.wins++; else p.loses++;
  save();
};

$('clearHistory').onclick = ()=>{ if(!selectedId) return alert('Выбери игрока'); if(!confirm('Очистить историю матчей?')) return; const p=find(selectedId); if(!p) return; p.matches=[]; save(); };

function renderHistory(p){
  const list = $('historyList'); list.innerHTML='';
  const arr = (p.matches||[]).slice(-12).reverse();
  arr.forEach(m=>{
    const el = document.createElement('div'); el.className='small'; el.style.display='flex'; el.style.justifyContent='space-between'; el.style.alignItems='center'; el.style.padding='6px'; el.style.borderRadius='6px'; el.style.background='rgba(255,255,255,0.01)';
    el.innerHTML = `<div>K:${m.k} A:${m.a} D:${m.d} R:${m.r}</div><div>${m.win? 'W':'L'} • ${new Date(m.timestamp).toLocaleString()}</div>`;
    list.appendChild(el);
  });
  // draw sparkline for kills
  drawSpark(p.matches||[]);
}

function drawSpark(matches){
  const canvas = $('spark'); if(!canvas) return;
  const ctx = canvas.getContext('2d');
  const data = (matches||[]).slice(-24).map(m=>m.k);
  const w = canvas.clientWidth; const h = canvas.clientHeight;
  canvas.width = Math.round(w*devicePixelRatio); canvas.height = Math.round(h*devicePixelRatio);
  ctx.scale(devicePixelRatio, devicePixelRatio);
  ctx.clearRect(0,0,w,h);
  if(!data.length) return;
  const max = Math.max(...data); const min = Math.min(...data);
  const span = Math.max(1, max - min);
  ctx.lineWidth = 2; ctx.strokeStyle = getComputedStyle(document.body).getPropertyValue('--accent') || '#6ee7b7';
  ctx.beginPath();
  data.forEach((v,i)=>{
    const x = (i/(data.length-1 || 1))*(w-8)+4;
    const y = h - ((v - min) / span) * (h-8) - 4;
    if(i===0) ctx.moveTo(x,y); else ctx.lineTo(x,y);
  });
  ctx.stroke();
}

/* ---------- Модальные окна: Звания и Номинации ---------- */
function openRanksModal(){
  const root = $('ranksContent');
  root.innerHTML = '';
  // Build rank sections
  RANKS_INFO.forEach(r=>{
    const playersWithRank = players.filter(p=> computeRank(p).id === r.id);
    const div = document.createElement('div');
    div.style.padding = '8px';
    div.style.borderBottom = '1px solid rgba(255,255,255,0.03)';
    div.innerHTML = `
      <div style="display:flex;justify-content:space-between;align-items:center">
        <div style="font-weight:700">${r.name} <span class="badge ${r.cls}" style="margin-left:8px">${r.name}</span></div>
        <div class="small">порог: ${r.min} — ${r.max}</div>
      </div>
      <div class="small" style="margin-top:6px">${escapeHtml(r.how)}</div>
      <div class="small" style="margin-top:6px"><b>Игроки:</b> ${playersWithRank.length ? playersWithRank.map(p=>escapeHtml(p.name)).join(', ') : '—'}</div>
    `;
    root.appendChild(div);
  });
  $('ranksModal').style.display = 'flex';
}
function closeRanksModal(){ $('ranksModal').style.display = 'none'; }

function openNomsModal(){
  const root = $('nomsContent');
  root.innerHTML = '';
  // describe nominations with winners
  const defs = {
    'Лучший рейтинг (тек.)': 'Игрок с наибольшим текущим RATING (среднее нормализованных метрик ×100).',
    'Лучший KD (тек.)': 'Наибольший KD = KILLS / DEATHS (Perfect при D=0).',
    'Лучший AVG (убийства/раунд)': 'Наибольшее среднее убийств за раунд (AVG).',
    'Лучший матч (макс убийств в матче)': 'Максимум убийств в одной записи матча.',
    'Лучший винрейт (min 3 матча)': 'Игрок с наибольшим WINRATE при условии ≥3 матчей.',
    'Highest Impact (MVP-like)': 'Сумма (k + 0.5*a − 0.3*d) по всем матчам — приближённый показатель влияния.'
  };
  const winners = computeNominations(players);
  for(const key in defs){
    const pid = winners[key];
    const winName = pid ? (players.find(p=>p.id===pid)||{name:'?'}).name : '—';
    const el = document.createElement('div');
    el.style.padding='8px'; el.style.borderBottom='1px solid rgba(255,255,255,0.03)';
    el.innerHTML = `<div style="display:flex;justify-content:space-between"><div style="font-weight:700">${escapeHtml(key)}</div><div class="small">${escapeHtml(winName)}</div></div><div class="small" style="margin-top:6px">${escapeHtml(defs[key])}</div>`;
    root.appendChild(el);
  }
  $('nomsModal').style.display = 'flex';
}
function closeNomsModal(){ $('nomsModal').style.display = 'none'; }

$('ranksBtn').onclick = openRanksModal;
$('nomsBtn').onclick = openNomsModal;
$('closeRanks').onclick = closeRanksModal;
$('closeNoms').onclick = closeNomsModal;

/* ---------- Малые утилиты ---------- */
function escapeHtml(s){ return String(s).replace(/[&<>"]+/g, m => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;'}[m]||m)); }

/* ---------- События поиска/сортировки ---------- */
$('searchInput').oninput = renderList; $('sortSelect').onchange = renderList;

/* ---------- Инициализация ---------- */
load();
if(players.length && !selectedId) selectedId = players[0].id;
renderList();
renderSelected();

// keep canvas responsive on resize
window.addEventListener('resize', ()=>{ if(selectedId){ const p=find(selectedId); if(p && p.matches && p.matches.length) drawSpark(p.matches); } });

</script>

<!-- === admin panel (сохранил, но убрал защиту с весов) === -->
<script>
(function(){
  const ADMIN_KEY = 'is_admin_v3';
  const PASSWORD = '5ugaradmin'; // временно — рекомендуется перенести на сервер

  function isAdmin(){ return localStorage.getItem(ADMIN_KEY) === '1'; }
  function setAdmin(on){
    localStorage.setItem(ADMIN_KEY, on ? '1' : '0');
    updateAdminUI();
  }

  function createAdminPanel(){
    const header = document.querySelector('header');
    if(!header) return;
    const wrapper = document.createElement('div');
    wrapper.id = 'adminPanelWrapper';
    wrapper.style.display = 'flex';
    wrapper.style.alignItems = 'center';
    wrapper.style.gap = '8px';
    wrapper.style.marginLeft = '12px';
    wrapper.innerHTML = `
      <div id="adminControls" style="display:flex;gap:8px;align-items:center">
        <div id="adminBadge" style="font-weight:700;display:none;color:#ffd27f">ADMIN</div>
        <button id="adminLoginBtn">Войти как админ</button>
        <button id="adminLogoutBtn" style="display:none">Выйти</button>
      </div>
    `;
    const target = header.querySelector('.controls') || header;
    target.appendChild(wrapper);

    document.getElementById('adminLoginBtn').addEventListener('click', ()=>{
      const pw = prompt('Введите пароль администратора');
      if(pw === null) return;
      if(pw === PASSWORD){ setAdmin(true); alert('Админ включён'); }
      else alert('Неверный пароль');
    });
    document.getElementById('adminLogoutBtn').addEventListener('click', ()=>{ setAdmin(false); alert('Админ выключен'); });
  }

  function updateAdminUI(){
    const admin = isAdmin();
    const badge = document.getElementById('adminBadge');
    const loginBtn = document.getElementById('adminLoginBtn');
    const logoutBtn = document.getElementById('adminLogoutBtn');
    if(badge) badge.style.display = admin ? 'inline-block' : 'none';
    if(loginBtn) loginBtn.style.display = admin ? 'none' : 'inline-block';
    if(logoutBtn) logoutBtn.style.display = admin ? 'inline-block' : 'none';

    const protectedIds = [
      'deletePlayer','resetPlayer',
      'addMatchBtn','clearHistory',
      'clearAll','exportAll'
    ];
    protectedIds.forEach(id=>{
      const el = document.getElementById(id);
      if(el) el.disabled = !admin;
    });

    document.querySelectorAll('[data-op]').forEach(b=> b.disabled = !admin);
    ['editKills','editAssists','editDeaths','editRounds','editWins','editLoses','editName'].forEach(id=>{
      const el = document.getElementById(id);
      if(el) el.disabled = !admin;
    });
  }

  // block click on disabled buttons
  document.addEventListener('click', function(e){
    const btn = e.target.closest('button');
    if(!btn) return;
    if(btn.disabled){
      e.stopImmediatePropagation();
      e.preventDefault();
      if(!isAdmin()) {
        console.warn('Действие заблокировано — требуется админ статус');
      }
    }
  }, true);

  createAdminPanel();
  updateAdminUI();
  window.__setAdmin = setAdmin;
})();
</script>
<!-- === /admin panel === -->

</body>
</html>
